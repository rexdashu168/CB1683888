<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤ (Ultimate)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ====== è¦–è¦ºç³»çµ±è¨­å®š ====== */
        :root { 
            --primary: #0f172a; --secondary: #334155; 
            --accent: #0ea5e9; --accent-hover: #0284c7;
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --sidebar-w: 280px; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-top: 60px; overflow-x: hidden; }
        
        /* ====== é ‚éƒ¨å°èˆª ====== */
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-bottom: 1px solid #e2e8f0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary); }
        .header-title { font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .db-status { font-size: 12px; font-weight: 600; color: #10b981; background: #ecfdf5; padding: 4px 12px; border-radius: 20px; border: 1px solid #a7f3d0; }

        /* ====== å´é‚Šé¸å–® ====== */
        .sidebar { position: fixed; left: calc(var(--sidebar-w) * -1); top: 0; width: var(--sidebar-w); height: 100vh; background: var(--card); transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; overflow-y: auto; box-shadow: 10px 0 25px -5px rgba(0,0,0,0.1); border-right: 1px solid #e2e8f0; }
        .sidebar.active { left: 0; }
        .sidebar-header { background: var(--primary); padding: 30px 25px; color: white; }
        .sidebar-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
        .sidebar-subtitle { font-size: 12px; opacity: 0.7; letter-spacing: 1px; text-transform: uppercase; }
        
        .menu-section { padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .menu-label { padding: 0 25px 8px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: var(--secondary); gap: 12px; transition: all 0.2s; font-weight: 500; text-decoration: none; border-left: 3px solid transparent; }
        .menu-item:hover { background: #f1f5f9; color: var(--accent); }
        .menu-item.active { background: #f0f9ff; color: var(--accent); border-left-color: var(--accent); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.4); display: none; z-index: 1500; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        /* ====== å…§å®¹å€ ====== */
        .page-content { display: none; padding: 25px 20px; max-width: 1200px; margin: 0 auto; animation: fadeUp 0.4s ease-out; }
        .page-content.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æœå°‹çµ„ä»¶ */
        .search-box { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .search-wrapper { display: flex; gap: 10px; margin-top: 15px; }
        .search-input { flex: 1; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: 0.2s; outline: none; color: var(--text); }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .search-btn { padding: 0 30px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .search-btn:hover { background: var(--accent-hover); }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #e2e8f0; transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border-color: var(--accent); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px dashed #e2e8f0; }
        
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .data-cell { background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center; }
        .data-label { font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 500; }
        .data-value { font-size: 17px; font-weight: 700; color: var(--primary); }
        
        .tag { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; margin-right: 5px; }
        .tag-blue { background: #e0f2fe; color: #0284c7; }
        .tag-green { background: #dcfce7; color: #16a34a; }
        .tag-orange { background: #ffedd5; color: #ea580c; }

        /* è©³æƒ… Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.75); z-index: 2500; padding: 20px; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal.active { display: flex; justify-content: center; align-items: flex-start; }
        .modal-content { background: #fff; width: 100%; max-width: 900px; border-radius: 20px; padding: 30px; position: relative; margin-bottom: 50px; animation: slideUp 0.3s ease-out; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .close-modal:hover { color: var(--accent); }

        .section-head { display: flex; align-items: center; gap: 10px; margin: 30px 0 15px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; }
        .section-head h3 { font-size: 18px; font-weight: 700; color: var(--primary); margin: 0; }
        .section-icon { font-size: 20px; }

        .chart-box { height: 350px; width: 100%; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.02); }
        
        /* å ±å‘Šæ¨£å¼ */
        .report-item { padding: 15px; border-radius: 8px; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 10px; transition: 0.2s; }
        .report-item:hover { border-color: #cbd5e1; background: #fff; }
        .rex-insight { background: #fff1f2; border: 1px solid #fecdd3; color: #be123c; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; line-height: 1.6; }

        /* è¼‰å…¥å‹•ç•« */
        .loader { position: fixed; inset: 0; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        .progress-bar-container { width: 240px; height: 4px; background: #f1f5f9; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <h3 style="color: var(--primary);">Rexå¤§å”æˆ°æƒ…å®¤ å•Ÿå‹•ä¸­</h3>
        <div id="loadStatus" style="font-size: 13px; color: #64748b; margin-top: 5px;">æ­£åœ¨é€£çµ GitHub è³‡æ–™åº«...</div>
        <div class="progress-bar-container"><div id="progressFill" class="progress-bar"></div></div>
    </div>

    <header class="header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
            <div class="header-title">Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</div>
        </div>
        <div class="db-status" id="dbBadge">DB: é€£ç·šä¸­</div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Rexå¤§å”168</div>
            <div class="sidebar-subtitle">Flagship System v7.0</div>
        </div>
        
        <div class="menu-section">
            <div class="menu-label">æ ¸å¿ƒæ¨¡çµ„</div>
            <a class="menu-item active" onclick="showPage('home')"><span>ğŸ </span> æˆ°æƒ…å®¤é¦–é </a>
            <a class="menu-item" onclick="showPage('basic')"><span>ğŸ“‹</span> åŸºæœ¬è³‡æ–™åº«</a>
            <a class="menu-item" onclick="showPage('auction')"><span>ğŸ”¨</span> ç«¶æ‹æ•¸æ“š</a>
        </div>

        <div class="menu-section">
            <div class="menu-label">æ·±åº¦åˆ†æ</div>
            <a class="menu-item" onclick="showPage('cbas')"><span>ğŸ“ˆ</span> CBAS ç±Œç¢¼æ‹†è§£</a>
            <a class="menu-item" onclick="showPage('history')"><span>ğŸ“Š</span> æ­·å²è¡Œæƒ…å›æ¸¬</a>
        </div>

        <div class="menu-section">
            <div class="menu-label">è³ªåŒ–ç ”ç©¶</div>
            <a class="menu-item" onclick="showPage('report')"><span>ğŸ“‘</span> å€‹è‚¡ç ”ç©¶å ±å‘Š</a>
            <a class="menu-item" onclick="showPage('industry')"><span>ğŸ­</span> ç”¢æ¥­èˆ‡æ¦‚å¿µè‚¡</a>
        </div>
    </div>
    <div id="overlay" class="overlay" onclick="closeMenu()"></div>

    <div id="page-home" class="page-content active">
        <div class="search-box">
            <h2 style="color:var(--primary); margin-bottom:10px;">å…¨åŸŸæ™ºèƒ½æœå°‹</h2>
            <p style="color:#64748b; font-size:14px; margin-bottom:20px;">æ•´åˆ 16 å€‹å·¥ä½œè¡¨æ•¸æ“šï¼Œè¼¸å…¥ä»£è™Ÿã€åç¨±æˆ–æ¦‚å¿µé—œéµå­—</p>
            <div class="search-wrapper">
                <input type="text" class="search-input" id="mainSearch" placeholder="ä¾‹ï¼š68732, äºåŠ›, AIä¼ºæœå™¨..." onkeyup="if(event.key==='Enter') doSearch()">
                <button class="search-btn" onclick="doSearch()">æŸ¥è©¢</button>
            </div>
        </div>
        <div id="homeResults">
            <div style="text-align:center; padding: 80px 0; color: #cbd5e1;">
                <div style="font-size: 60px; margin-bottom: 10px;">ğŸš€</div>
                <p>æº–å‚™å¥½æ¢ç´¢å¯è½‰å‚µçš„æ·±å±¤åƒ¹å€¼äº†å—ï¼Ÿ</p>
            </div>
        </div>
    </div>

    <div id="page-basic" class="page-content"><h2>ğŸ“‹ CB åŸºæœ¬è³‡æ–™</h2><div id="basicList"></div></div>
    <div id="page-auction" class="page-content"><h2>ğŸ”¨ ç«¶æ‹æ•¸æ“šåº«</h2><div id="auctionList"></div></div>
    <div id="page-cbas" class="page-content"><h2>ğŸ“ˆ CBAS æ¬Šåˆ©é‡‘æ‹†è§£</h2><div id="cbasList"></div></div>
    <div id="page-history" class="page-content"><h2>ğŸ“Š æ­·å²è¡Œæƒ…</h2><div id="historyList"></div></div>
    <div id="page-report" class="page-content"><h2>ğŸ“‘ ç ”ç©¶å ±å‘Š</h2><div id="reportList"></div></div>
    <div id="page-industry" class="page-content"><h2>ğŸ­ ç”¢æ¥­æ¦‚å¿µ</h2><div id="industryList"></div></div>

    <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">Ã—</div>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// ================= 1. æ ¸å¿ƒè³‡æ–™åº«çµæ§‹ =================
const DB = {
    basic: {},      // 00_CB
    highlow: {},    // 00_CB
    auction: {},    // 00_CB
    industry: {},   // 00_CB (Sheet 16)
    concepts: {},   // 01_Report
    reports: {},    // 01_Report
    news: [],       // 01_Report
    cbas_latest: {}, // 02_CBAS
    time_series: {} // æ•´åˆ 04_Price (è‚¡åƒ¹) & 02_CBAS (æ¬Šåˆ©é‡‘/å¼µæ•¸) çš„æ­·å²æ•¸æ“š
};

const FILES = [
    { id: '00', name: '00_CB.xlsx', desc: 'åŸºæœ¬è³‡æ–™' },
    { id: '01', name: '01_Report.xlsx', desc: 'ç ”ç©¶å ±å‘Š' },
    { id: '02', name: '02_CBAS.xlsx', desc: 'CBASæ­·å²' },
    { id: '04', name: '04_Price.xlsx', desc: 'æ­·å²æˆäº¤åƒ¹' }
];

// ================= 2. ç³»çµ±åˆå§‹åŒ– =================
window.onload = async function() {
    await loadAllFiles();
};

async function loadAllFiles() {
    const statusEl = document.getElementById('loadStatus');
    const fillEl = document.getElementById('progressFill');
    let loaded = 0;

    for (let file of FILES) {
        try {
            statusEl.innerText = `æ­£åœ¨è®€å–: ${file.desc}...`;
            const res = await fetch(file.name);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const ab = await res.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            
            await parseWorkbook(file.id, wb);
            
            loaded++;
            fillEl.style.width = `${(loaded / FILES.length) * 100}%`;
        } catch (err) {
            console.error(err);
            statusEl.innerHTML += `<br><span style="color:#ef4444">âŒ ${file.name} è®€å–å¤±æ•—</span>`;
        }
    }

    setTimeout(() => {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => { 
            document.getElementById('loader').style.display = 'none'; 
            updateDbStatus();
        }, 500);
    }, 800);
}

// ================= 3. æ™ºæ…§è§£ææ ¸å¿ƒ (The Brain) =================
function parseWorkbook(id, workbook) {
    const sheetNames = workbook.SheetNames;

    if (id === '00') {
        processSheet(workbook, ['åŸºæœ¬è³‡æ–™','01_'], row => {
            const code = getField(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
            if(code) DB.basic[code] = row;
        });
        processSheet(workbook, ['æ›ç‰Œé«˜ä½','00_'], row => {
            const code = getField(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
            if(code) DB.highlow[code] = row;
        });
        processSheet(workbook, ['ç«¶æ‹','04_'], row => {
            const code = getField(row, ['CBä»£è™Ÿ']);
            if(code) DB.auction[code] = row;
        });
        processSheet(workbook, ['ç”¢æ¥­åˆ†é¡','16_'], row => {
            const stock = getField(row, ['è‚¡ç¥¨ä»£è™Ÿ','ä»£è™Ÿ']);
            if(stock) DB.industry[stock] = row;
        });
    }
    else if (id === '01') {
        // æ¦‚å¿µè‚¡
        processSheet(workbook, ['æ¦‚å¿µè‚¡'], row => {
            const stock = getField(row, ['è‚¡ç¥¨ä»£è™Ÿ','ä»£è™Ÿ']);
            if(stock) {
                if(!DB.concepts[stock]) DB.concepts[stock] = [];
                DB.concepts[stock].push(row);
            }
        });
        // å ±å‘Š
        processSheet(workbook, ['è©³ç´°å…§å®¹','å€‹è‚¡'], row => {
            const stock = getField(row, ['è‚¡è™Ÿ','è‚¡ç¥¨ä»£è™Ÿ']);
            if(stock) {
                if(!DB.reports[stock]) DB.reports[stock] = [];
                DB.reports[stock].push(row);
            }
        });
        // æ–°è
        processSheet(workbook, ['å¤–é›»','æ–°è'], row => { if(row['å…¬å¸']) DB.news.push(row); });
    }
    else if (id === '02') {
        // è™•ç† CBAS æ­·å² (è‡ªå‹•éæ­·æ‰€æœ‰æœˆä»½ Sheet)
        sheetNames.forEach(name => {
            if (name.match(/^\d+/)) { // 10004, 11409...
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[name]);
                const dateStr = parseTwDate(name); // "2025-09"
                
                data.forEach(row => {
                    const code = getField(row, ['CBä»£è™Ÿ','å¯è½‰å‚µä»£è™Ÿ']);
                    if (code) {
                        if (!DB.time_series[code]) DB.time_series[code] = {};
                        if (!DB.time_series[code][dateStr]) DB.time_series[code][dateStr] = {};

                        // è¨ˆç®—å¼µæ•¸èˆ‡åƒ¹æ ¼
                        const principal = parseFloat(getField(row, ['åç›®æœ¬é‡‘'])) || 0;
                        const vol = Math.round(principal / 100000);
                        const price = parseFloat(getField(row, ['æœ€ä½æ¬Šåˆ©é‡‘(å…ƒ)','æ¬Šåˆ©é‡‘'])) || 0;

                        DB.time_series[code][dateStr].cbas_vol = vol;
                        DB.time_series[code][dateStr].cbas_price = price;

                        // æ›´æ–°æœ€æ–°
                        const curr = DB.cbas_latest[code];
                        if (!curr || dateStr > curr.date) {
                            DB.cbas_latest[code] = { date: dateStr, vol, price };
                        }
                    }
                });
            }
        });
    }
    else if (id === '04') {
        // è™•ç† åƒ¹æ ¼ æ­·å²
        sheetNames.forEach(name => {
            if (name.match(/^\d+/)) {
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[name]);
                const dateStr = parseTwDate(name);

                data.forEach(row => {
                    const code = getField(row, ['ä»£è™Ÿ','CBä»£è™Ÿ']);
                    if (code) {
                        if (!DB.time_series[code]) DB.time_series[code] = {};
                        if (!DB.time_series[code][dateStr]) DB.time_series[code][dateStr] = {};
                        
                        DB.time_series[code][dateStr].close = parseFloat(getField(row, ['å¹³å‡','å¹³å‡åƒ¹'])) || 0;
                        DB.time_series[code][dateStr].high = parseFloat(getField(row, ['æœ€é«˜','æœ€é«˜åƒ¹'])) || 0;
                        DB.time_series[code][dateStr].low = parseFloat(getField(row, ['æœ€ä½','æœ€ä½åƒ¹'])) || 0;
                    }
                });
            }
        });
    }
}

// è¼”åŠ©å·¥å…·
function parseTwDate(name) {
    const year = parseInt(name.slice(0, -2)) + 1911;
    const month = name.slice(-2);
    return `${year}-${month}`;
}
function processSheet(wb, keys, cb) {
    const name = wb.SheetNames.find(n => keys.some(k => n.includes(k)));
    if(name) XLSX.utils.sheet_to_json(wb.Sheets[name]).forEach(cb);
}
function getField(row, keys) {
    for(let k of keys) if(row[k]!==undefined) return String(row[k]).trim();
    return null;
}
function updateDbStatus() {
    document.getElementById('dbBadge').innerText = `DB: ${Object.keys(DB.basic).length} æª” (Ready)`;
}

// ================= 4. UI äº’å‹• =================
function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('active');
    document.getElementById('overlay').classList.toggle('active');
}
function closeMenu() {
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
}
function showPage(id) {
    closeMenu();
    document.querySelectorAll('.page-content').forEach(e => e.classList.remove('active'));
    document.getElementById(`page-${id}`).classList.add('active');
    
    document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');

    if (id !== 'home') renderList(id);
}

function doSearch() {
    const val = document.getElementById('mainSearch').value.trim().toUpperCase();
    if(!val) return;
    
    const resDiv = document.getElementById('homeResults');
    resDiv.innerHTML = '';
    const results = new Set();

    // æœå°‹é‚è¼¯
    for (let code in DB.basic) {
        const b = DB.basic[code];
        if (code.includes(val) || b['åç¨±'].includes(val) || b['è‚¡ç¥¨ä»£è™Ÿ'].includes(val)) results.add(code);
    }
    // æ¦‚å¿µè‚¡åæŸ¥
    for (let stock in DB.concepts) {
        const list = DB.concepts[stock];
        if (list.some(c => c['æ¦‚å¿µåˆ†é¡']?.includes(val) || c['é¡Œæèªªæ˜']?.includes(val))) {
            for(let cbCode in DB.basic) if(DB.basic[cbCode]['è‚¡ç¥¨ä»£è™Ÿ'] == stock) results.add(cbCode);
        }
    }

    if(results.size === 0) {
        resDiv.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:40px;">æŸ¥ç„¡è³‡æ–™</div>';
        return;
    }

    results.forEach(code => resDiv.appendChild(createCard(code)));
}

function createCard(code) {
    const b = DB.basic[code] || {};
    const cbas = DB.cbas_latest[code] || {};
    const stock = getField(b, ['è‚¡ç¥¨ä»£è™Ÿ','è‚¡è™Ÿ']);
    const ind = DB.industry[stock] || {};
    
    const div = document.createElement('div');
    div.className = 'card';
    div.onclick = () => showDetail(code);
    div.innerHTML = `
        <div class="card-header">
            <div>
                <span class="cb-name">${b['åç¨±']||code}</span> 
                <span class="cb-code">${code}</span>
            </div>
            <span class="tag tag-blue">${ind['ç”¢æ¥­']||'--'}</span>
        </div>
        <div class="data-grid">
            <div class="data-cell"><div class="data-label">CBASæ¬Šåˆ©é‡‘</div><div class="data-value red">${cbas.price||'--'}</div></div>
            <div class="data-cell"><div class="data-label">æ‹†è§£å¼µæ•¸</div><div class="data-value blue">${cbas.vol||'--'}</div></div>
            <div class="data-cell"><div class="data-label">ç™¼è¡Œè¦æ¨¡</div><div class="data-value">${b['ç™¼è¡Œè¦æ¨¡']||'--'}å„„</div></div>
            <div class="data-cell"><div class="data-label">è½‰æ›åƒ¹æ ¼</div><div class="data-value">${b['è½‰æ›åƒ¹æ ¼']||'--'}</div></div>
        </div>
    `;
    return div;
}

function renderList(pageId) {
    const div = document.getElementById(pageId + 'List');
    div.innerHTML = '';
    let source = DB.basic;
    if(pageId==='auction') source=DB.auction;
    
    let count = 0;
    for(let code in source) {
        if(count++ > 50) break;
        const realCode = getField(source[code], ['CBä»£è™Ÿ','ä»£è™Ÿ']) || code;
        if(DB.basic[realCode]) div.appendChild(createCard(realCode));
    }
}

// ================= 5. è©³æƒ…é  (Ultimate) =================
function showDetail(code) {
    const b = DB.basic[code] || {};
    const a = DB.auction[code] || {};
    const hl = DB.highlow[code] || {};
    const stock = getField(b, ['è‚¡ç¥¨ä»£è™Ÿ','è‚¡è™Ÿ']);
    const ind = DB.industry[stock] || {};
    const concepts = DB.concepts[stock] || [];
    const reports = DB.reports[stock] || [];
    
    // æº–å‚™åœ–è¡¨æ•¸æ“š (åˆä½µ Time Series)
    const timeObj = DB.time_series[code] || {};
    const dates = Object.keys(timeObj).sort();
    const chartData = dates.map(d => ({
        date: d,
        price: timeObj[d].close,
        cbas: timeObj[d].cbas_price,
        vol: timeObj[d].cbas_vol
    }));

    const modalBody = document.getElementById('modalBody');
    const conceptTags = concepts.map(c => `<span class="tag tag-orange">${c['æ¦‚å¿µåˆ†é¡']}</span>`).join('');
    const conceptList = concepts.map(c => `<li style="margin-bottom:5px;font-size:13px;color:#64748b;"><b>${c['æ¦‚å¿µåˆ†é¡']}:</b> ${c['é¡Œæèªªæ˜']}</li>`).join('');

    modalBody.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div><span style="font-size:24px;font-weight:800;color:var(--primary);">${b['åç¨±']}</span> <span style="color:#94a3b8;font-size:16px;">${code}</span></div>
            <div style="text-align:right;font-size:12px;color:#64748b;">${b['ç™¼è¡Œæ—¥æœŸ']||'--'} ~ ${b['åˆ°æœŸæ—¥æœŸ']||'--'}</div>
        </div>
        <div class="tags" style="margin-bottom:20px;">${conceptTags} <span class="tag tag-green">${ind['ç´°åˆ†ç”¢æ¥­']||''}</span></div>
        
        ${ind['ç”¢æ¥­åœ°ä½èªªæ˜'] ? `<div style="background:#f1f5f9;padding:10px;border-radius:8px;font-size:13px;color:#475569;margin-bottom:20px;">ğŸ† <b>ç”¢æ¥­åœ°ä½ï¼š</b>${ind['ç”¢æ¥­åœ°ä½èªªæ˜']}</div>` : ''}

        <div class="section-head"><span class="section-icon">ğŸ“ˆ</span><h3>åƒ¹æ ¼èˆ‡ç±Œç¢¼é€è¦–</h3></div>
        <div class="data-grid" style="margin-bottom:15px;">
            <div class="data-cell"><div class="data-label">ç«¶æ‹å‡åƒ¹</div><div class="data-value">${getField(a,['å¹³å‡å¾—æ¨™'])||'--'}</div></div>
            <div class="data-cell"><div class="data-label">å¾—æ¨™å€æ•¸</div><div class="data-value blue">${getField(a,['å¾—æ¨™å€æ•¸'])||'--'}å€</div></div>
            <div class="data-cell"><div class="data-label">æ›ç‰Œæœ€é«˜</div><div class="data-value red">${getField(hl,['æ›ç‰Œæœ€é«˜'])||'--'}</div></div>
            <div class="data-cell"><div class="data-label">è½‰æ›åƒ¹æ ¼</div><div class="data-value">${b['è½‰æ›åƒ¹æ ¼']||'--'}</div></div>
        </div>
        <div id="mainChart" class="chart-box"></div>
        
        ${conceptList ? `<div class="section-head"><span class="section-icon">ğŸ”¥</span><h3>é¡Œææ¦‚å¿µ</h3></div><ul style="padding-left:20px;">${conceptList}</ul>` : ''}

        <div class="section-head"><span class="section-icon">ğŸ“‘</span><h3>Rexå¤§å”è§€é» & æ³•äººå ±å‘Š</h3></div>
        <div style="display:grid; gap:10px;">
            ${reports.length ? reports.map(r => `
                <div class="report-item">
                    <div style="display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin-bottom:5px;">
                        <span>${r['å ±å‘Šæ—¥æœŸ']} | ${r['åˆ¸å•†']}</span>
                        <span class="tag tag-blue">${r['æŠ•è³‡è©•ç­‰']||'N/A'}</span>
                    </div>
                    <div style="font-size:14px;color:#334155;line-height:1.5;">${r['ç²¾ç°¡é‡é»æ‘˜è¦']||'ç„¡æ‘˜è¦'}</div>
                    ${r['Rexè§€å¯Ÿ'] ? `<div class="rex-insight">ğŸ’¡ <b>Rexè§€å¯Ÿï¼š</b>${r['Rexè§€å¯Ÿ']}</div>` : ''}
                </div>
            `).join('') : '<div style="text-align:center;color:#cbd5e1;">æš«ç„¡å ±å‘Š</div>'}
        </div>
    `;

    document.getElementById('detailModal').classList.add('active');

    // ç¹ªè£½åœ–è¡¨ (æ··åˆåœ–ï¼šKç·š/è‚¡åƒ¹ + CBAS)
    setTimeout(() => {
        if(chartData.length > 0) drawMainChart(chartData);
        else document.getElementById('mainChart').innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#cbd5e1">ç„¡æ­·å²æ•¸æ“š</div>';
    }, 200);
}

function drawMainChart(data) {
    const chart = echarts.init(document.getElementById('mainChart'));
    const dates = data.map(d => d.date);
    const prices = data.map(d => d.price); // è‚¡åƒ¹/CBåƒ¹
    const cbasPrices = data.map(d => d.cbas || 0); // æ¬Šåˆ©é‡‘
    
    const option = {
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
        legend: { data: ['æˆäº¤å‡åƒ¹', 'CBASæ¬Šåˆ©é‡‘'], bottom: 0 },
        grid: { left: '10%', right: '10%', top: '10%', bottom: '15%' },
        xAxis: { type: 'category', data: dates },
        yAxis: [
            { type: 'value', name: 'åƒ¹æ ¼', position: 'left', scale:true },
            { type: 'value', name: 'æ¬Šåˆ©é‡‘', position: 'right', scale:true, splitLine: { show: false } }
        ],
        series: [
            { name: 'æˆäº¤å‡åƒ¹', type: 'line', data: prices, itemStyle: { color: '#0f172a' }, smooth: true },
            { name: 'CBASæ¬Šåˆ©é‡‘', type: 'line', yAxisIndex: 1, data: cbasPrices, itemStyle: { color: '#ef4444' }, areaStyle: { opacity: 0.1 } }
        ]
    };
    chart.setOption(option
