<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ====== æ ¸å¿ƒåŸºç¤æ¨£å¼ ====== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif; background: #f5f7fa; min-height: 100vh; color: #333; padding-top: 55px; }
        
        /* ====== å°èˆªåˆ— ====== */
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 0 15px; height: 55px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .menu-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .header-title { font-size: 17px; font-weight: 600; }
        .header-badge { background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 15px; font-size: 12px; }

        /* ====== å´é‚Šé¸å–® ====== */
        .sidebar { position: fixed; left: -300px; top: 0; width: 300px; height: 100vh; background: white; transition: left 0.3s ease; z-index: 2000; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.active { left: 0; }
        .sidebar-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 25px 20px; color: white; }
        .sidebar-title { font-size: 18px; font-weight: 600; }
        .menu-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 600; }
        .menu-item { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; color: #333; gap: 15px; transition: 0.2s; }
        .menu-item:hover { background: #f8f9fa; }
        .menu-item.active { background: #e8f0fe; color: #1a73e8; border-left: 4px solid #1a73e8; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .overlay.active { display: block; }

        /* ====== é€šç”¨å…ƒä»¶ ====== */
        .page-content { display: none; padding-bottom: 40px; animation: fadeIn 0.3s; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .search-container { background: white; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .search-input:focus { border-color: #1a73e8; outline: none; }
        .search-btn { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        .card { background: white; margin: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; padding: 20px; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .result-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .result-value { font-size: 20px; font-weight: 700; color: #333; }
        .result-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .red { color: #ea4335; } .green { color: #34a853; } .blue { color: #1a73e8; }

        /* é¦–é å¿«é€Ÿé€£çµ */
        .links-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 15px; }
        .link-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; cursor: pointer; }
        .link-icon { font-size: 28px; margin-bottom: 10px; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #f5f5f5; background: white; }
        .list-item:active { background: #f8f9fa; }
        
        /* æª”æ¡ˆä¸Šå‚³ */
        .file-upload-section { text-align: center; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .file-status { font-size: 13px; margin-top: 10px; line-height: 1.6; }
        .status-ok { color: #34a853; font-weight: bold; }
        .status-error { color: #ea4335; }

        /* è¼‰å…¥ç•«é¢ */
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #f0f0f0; border-top: 3px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
    </div>

    <header class="header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
            <div class="header-title">Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</div>
        </div>
        <div class="header-badge" id="dataBadge">è³‡æ–™æœªè¼‰å…¥</div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ“ˆ</div>
            <div class="sidebar-title">Rexå¤§å”168</div>
            <div style="font-size: 12px; opacity: 0.8;">å°ˆæ³¨é¢¨éšªãƒ»æ•¸æ“šé©…å‹•</div>
        </div>
        
        <div class="menu-group-title">ä¸»è¦åŠŸèƒ½</div>
        <a class="menu-item active" onclick="showPage('home')">ğŸ  é¦–é </a>
        <a class="menu-item" onclick="showPage('high-low-query')">ğŸ“Š CBæ›ç‰Œé«˜ä½æŸ¥è©¢</a>
        <a class="menu-item" onclick="showPage('issue-query')">ğŸ“‹ CBç™¼è¡ŒæŸ¥è©¢</a>
        <a class="menu-item" onclick="showPage('company-query')">ğŸ¢ åŒå…¬å¸ç™¼è¡ŒæŸ¥è©¢</a>
        
        <div class="menu-group-title">ç«¶æ‹èˆ‡åˆ†æ</div>
        <a class="menu-item" onclick="showPage('auction-query')">ğŸ”¨ ç«¶æ‹æŸ¥è©¢</a>
        <a class="menu-item" onclick="showPage('condition-analysis')">ğŸ” ç™¼è¡Œæ¢ä»¶åˆ†æ</a>
        <a class="menu-item" onclick="showPage('performance-analysis')">ğŸ“ˆ çµ„åˆç¸¾æ•ˆåˆ†æ</a>

        <div class="menu-group-title">ç ”ç©¶å ±å‘Š</div>
        <a class="menu-item" onclick="showPage('industry-concept')">ğŸ­ ç”¢æ¥­æ¦‚å¿µè‚¡</a>
        <a class="menu-item" onclick="showPage('foreign-news')">ğŸŒ å¤–é›»å ±å°</a>
        <a class="menu-item" onclick="showPage('stock-reports')">ğŸ“‘ å€‹è‚¡ç ”ç©¶å ±å‘Š</a>
    </div>

    <div id="overlay" class="overlay" onclick="closeMenu()"></div>

    <main>
        <div id="page-home" class="page-content active">
            <div class="search-container">
                <h3>ğŸ‘‹ æ­¡è¿ä½¿ç”¨æˆ°æƒ…å®¤</h3>
                <p style="color:#666; margin: 10px 0;">è«‹å…ˆè¼‰å…¥æ•¸æ“šåº«ä»¥å•Ÿç”¨å®Œæ•´åŠŸèƒ½ã€‚</p>
                
                <div class="file-upload-section">
                    <label class="search-btn" style="display:inline-block; width:auto; padding: 10px 20px;">
                        ğŸ“ è¼‰å…¥ Excel è³‡æ–™æª”
                        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="handleFiles(event)" style="display:none;">
                    </label>
                    <div id="fileStatus" class="file-status">
                        å¾…è¼‰å…¥æª”æ¡ˆï¼š<br>
                        00 (ä»£è™Ÿ/åŸºæœ¬/ç«¶æ‹)ã€01 (å ±å‘Š)ã€02 (CBAS)ã€04 (æˆäº¤åƒ¹)
                    </div>
                </div>
            </div>

            <div class="links-grid">
                <div class="link-card" onclick="showPage('high-low-query')"><div class="link-icon">ğŸ“Š</div>æ›ç‰Œé«˜ä½</div>
                <div class="link-card" onclick="showPage('auction-query')"><div class="link-icon">ğŸ”¨</div>ç«¶æ‹æŸ¥è©¢</div>
                <div class="link-card" onclick="showPage('company-query')"><div class="link-icon">ğŸ¢</div>åŒå…¬å¸æŸ¥è©¢</div>
                <div class="link-card" onclick="showPage('industry-concept')"><div class="link-icon">ğŸ­</div>ç”¢æ¥­æ¦‚å¿µ</div>
            </div>
        </div>

        <div id="page-high-low-query" class="page-content">
            <div class="search-container">
                <h3>ğŸ“Š æ›ç‰Œé«˜ä½æŸ¥è©¢</h3>
                <input type="text" class="search-input" id="hlInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨± (å¦‚: 23836)">
                <button class="search-btn" onclick="searchHighLow()">æŸ¥è©¢</button>
            </div>
            
            <div id="hlResult" class="card" style="display:none;">
                <h3 id="hlName">--</h3>
                <div class="result-grid">
                    <div class="result-item"><div class="result-label">æ›ç‰Œæœ€é«˜</div><div class="result-value red" id="hlHigh">--</div></div>
                    <div class="result-item"><div class="result-label">æ›ç‰Œæœ€ä½</div><div class="result-value green" id="hlLow">--</div></div>
                    <div class="result-item"><div class="result-label">æŒ¯å¹…</div><div class="result-value blue" id="hlAmp">--</div></div>
                    <div class="result-item"><div class="result-label">å¹³å‡å¾—æ¨™</div><div class="result-value" id="hlAvg">--</div></div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ”¥ æŒ¯å¹…æ’è¡Œæ¦œ TOP 20</h3>
                <div id="hlRanking">è«‹å…ˆè¼‰å…¥è³‡æ–™</div>
            </div>
        </div>

        <div id="page-issue-query" class="page-content">
            <div class="search-container">
                <h3>ğŸ“‹ CBç™¼è¡ŒæŸ¥è©¢</h3>
                <input type="text" class="search-input" id="issueInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±">
                <button class="search-btn" onclick="searchIssue()">æŸ¥è©¢</button>
            </div>
            <div id="issueResult" class="card" style="display:none;">
                </div>
        </div>

        <div id="page-company-query" class="page-content">
            <div class="search-container">
                <h3>ğŸ¢ åŒå…¬å¸ç™¼è¡ŒæŸ¥è©¢</h3>
                <input type="text" class="search-input" id="compInput" placeholder="è¼¸å…¥å…¬å¸å (å¦‚: è‰¯ç¶­)">
                <button class="search-btn" onclick="searchCompany()">æŸ¥è©¢</button>
            </div>
            <div id="compResult" style="padding-bottom: 20px;"></div>
        </div>

        <div id="page-auction-query" class="page-content">
            <div class="search-container">
                <h3>ğŸ”¨ ç«¶æ‹æŸ¥è©¢</h3>
                <input type="text" class="search-input" id="aucInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±">
                <button class="search-btn" onclick="searchAuction()">æŸ¥è©¢</button>
            </div>
            <div id="aucResult" class="card" style="display:none;"></div>
            <div id="aucList" style="padding: 0 15px;"></div>
        </div>

        <div id="page-industry-concept" class="page-content">
            <div class="search-container">
                <h3>ğŸ­ ç”¢æ¥­æ¦‚å¿µè‚¡</h3>
                <input type="text" class="search-input" id="indInput" placeholder="è¼¸å…¥ä»£è™Ÿã€åç¨±æˆ–ç”¢æ¥­">
                <button class="search-btn" onclick="searchIndustry()">æŸ¥è©¢</button>
            </div>
            <div id="indResult" class="card" style="display:none;"></div>
        </div>

        <div id="page-condition-analysis" class="page-content"><div class="card"><h3>åŠŸèƒ½é–‹ç™¼ä¸­...</h3></div></div>
        <div id="page-performance-analysis" class="page-content"><div class="card"><h3>åŠŸèƒ½é–‹ç™¼ä¸­...</h3></div></div>
        <div id="page-foreign-news" class="page-content"><div class="card"><h3>å¤–é›»å ±å° (éœ€è¼‰å…¥å ±å‘Šæª”)</h3><div id="newsList"></div></div></div>
        <div id="page-stock-reports" class="page-content"><div class="card"><h3>å€‹è‚¡ç ”ç©¶å ±å‘Š (éœ€è¼‰å…¥å ±å‘Šæª”)</h3><div id="reportList"></div></div></div>

    </main>

<script>
// ==========================================
// 1. ç‹€æ…‹ç®¡ç† (State Management)
// ==========================================
const AppState = {
    data: {
        highLow: {},      // ä¾†è‡ª 00_CBä»£è™Ÿåç¨± (Sheet 00)
        basic: {},        // ä¾†è‡ª 00_CBä»£è™Ÿåç¨± (Sheet 01)
        auction: {},      // ä¾†è‡ª 00_CBä»£è™Ÿåç¨± (Sheet 04)
        cbas: {},         // ä¾†è‡ª 02_CBAS
        prices: {},       // ä¾†è‡ª 04_CBæˆäº¤åƒ¹
        industry: {},     // ä¾†è‡ª 01_Report (ç”¢æ¥­åˆ†é¡)
        concepts: {},     // ä¾†è‡ª 01_Report (æ¦‚å¿µè‚¡)
        news: [],         // ä¾†è‡ª 01_Report (å¤–é›»)
        reports: []       // ä¾†è‡ª 01_Report (å€‹è‚¡å ±å‘Š)
    },
    filesLoaded: {
        t00: false, // åŸºæœ¬/é«˜ä½/ç«¶æ‹
        t01: false, // å ±å‘Š
        t02: false, // CBAS
        t04: false  // åƒ¹æ ¼
    }
};

// ==========================================
// 2. æª”æ¡ˆè™•ç†æ ¸å¿ƒ (File Handling)
// ==========================================
function handleFiles(event) {
    const files = event.target.files;
    if (!files.length) return;

    const statusDiv = document.getElementById('fileStatus');
    statusDiv.innerHTML = '<span style="color:#1a73e8">æ­£åœ¨è®€å–èˆ‡è§£ææª”æ¡ˆ...</span>';

    let processedCount = 0;
    const totalFiles = files.length;

    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const fname = file.name.toLowerCase();

                console.log(`Processing: ${fname}`);

                // æª”æ¡ˆè·¯ç”±é‚è¼¯
                if (fname.includes('00') || fname.includes('cbä»£è™Ÿ')) {
                    parseFile00(workbook);
                } else if (fname.includes('01') || fname.includes('report')) {
                    parseFile01(workbook);
                } else if (fname.includes('02') || fname.includes('cbas')) {
                    parseFile02(workbook);
                } else if (fname.includes('04') || fname.includes('æˆäº¤åƒ¹')) {
                    parseFile04(workbook);
                }

                processedCount++;
                if (processedCount === totalFiles) {
                    updateUIStatus();
                }
            } catch (err) {
                console.error(err);
                statusDiv.innerHTML += `<div class="status-error">âŒ è®€å–éŒ¯èª¤: ${file.name}</div>`;
            }
        };
        reader.readAsArrayBuffer(file);
    });
}

// è§£æ 00 è™Ÿæª”æ¡ˆ (æ ¸å¿ƒè³‡æ–™åº«)
function parseFile00(workbook) {
    // Sheet 00: é«˜ä½åƒ¹
    if (workbook.Sheets['00']) {
        const json = XLSX.utils.sheet_to_json(workbook.Sheets['00']);
        json.forEach(row => {
            const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').trim();
            if(code) {
                AppState.data.highLow[code] = {
                    name: row['CBåç¨±'] || row['åç¨±'],
                    high: parseFloat(row['æ›ç‰Œæœ€é«˜'] || 0),
                    low: parseFloat(row['æ›ç‰Œæœ€ä½'] || 0),
                    avgBid: parseFloat(row['å¹³å‡å¾—æ¨™'] || 100),
                    method: row['ç™¼è¡Œæ–¹å¼'] || ''
                };
            }
        });
    }
    // Sheet 01: åŸºæœ¬è³‡æ–™
    if (workbook.Sheets['01']) {
        const json = XLSX.utils.sheet_to_json(workbook.Sheets['01']);
        json.forEach(row => {
            const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').trim();
            if(code) AppState.data.basic[code] = row;
        });
    }
    // Sheet 04: ç«¶æ‹è³‡æ–™
    if (workbook.Sheets['04']) {
        const json = XLSX.utils.sheet_to_json(workbook.Sheets['04']);
        json.forEach(row => {
            const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').trim();
            if(code) AppState.data.auction[code] = row;
        });
    }
    AppState.filesLoaded.t00 = true;
}

// è§£æ 01 å ±å‘Šæª”æ¡ˆ
function parseFile01(workbook) {
    // ç”¢æ¥­åˆ†é¡
    if (workbook.Sheets['ç”¢æ¥­åˆ†é¡']) {
        const json = XLSX.utils.sheet_to_json(workbook.Sheets['ç”¢æ¥­åˆ†é¡']);
        json.forEach(row => {
            const code = String(row['ä»£è™Ÿ'] || '').trim();
            if(code) AppState.data.industry[code] = row;
        });
    }
    // æ¦‚å¿µè‚¡
    if (workbook.Sheets['æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«']) {
        const json = XLSX.utils.sheet_to_json(workbook.Sheets['æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«']);
        json.forEach(row => {
            const code = String(row['è‚¡ç¥¨ä»£è™Ÿ'] || '').trim();
            if(code) {
                if (!AppState.data.concepts[code]) AppState.data.concepts[code] = [];
                AppState.data.concepts[code].push(row);
            }
        });
    }
    // å¤–é›»èˆ‡å ±å‘Š
    if (workbook.Sheets['å¤–é›»ç¶œåˆå ±å°']) {
        AppState.data.news = XLSX.utils.sheet_to_json(workbook.Sheets['å¤–é›»ç¶œåˆå ±å°']);
    }
    if (workbook.Sheets['è©³ç´°å…§å®¹åº«']) {
        AppState.data.reports = XLSX.utils.sheet_to_json(workbook.Sheets['è©³ç´°å…§å®¹åº«']);
    }
    AppState.filesLoaded.t01 = true;
}

// è§£æ 02 CBAS
function parseFile02(workbook) {
    // ç°¡åŒ–é‚è¼¯ï¼šè®€å–ç¬¬ä¸€å€‹ Sheet
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    json.forEach(row => {
        const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').trim();
        if(code) AppState.data.cbas[code] = row;
    });
    AppState.filesLoaded.t02 = true;
}

// è§£æ 04 æˆäº¤åƒ¹
function parseFile04(workbook) {
    // è®€å–æœ€æ–°çš„æœˆä»½ (å‡è¨­æœ€å¾Œä¸€å€‹ Sheet æ˜¯æœ€æ–°çš„)
    const lastSheet = workbook.SheetNames[workbook.SheetNames.length - 1];
    const json = XLSX.utils.sheet_to_json(workbook.Sheets[lastSheet]);
    json.forEach(row => {
        const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').trim();
        if(code) AppState.data.prices[code] = row;
    });
    AppState.filesLoaded.t04 = true;
}

function updateUIStatus() {
    const loaded = Object.keys(AppState.data.basic).length;
    const statusDiv = document.getElementById('fileStatus');
    const badge = document.getElementById('dataBadge');
    
    statusDiv.innerHTML = `<div class="status-ok">âœ… æª”æ¡ˆè§£æå®Œæˆ</div>
    <small>CBè³‡æ–™: ${loaded} ç­† | å ±å‘Š: ${AppState.data.reports.length} ç¯‡</small>`;
    
    badge.innerText = `è³‡æ–™åº«å°±ç·’ (å…± ${loaded} æª”)`;
    
    // è‡ªå‹•åˆ·æ–°æ’è¡Œæ¦œ
    updateHighLowRanking();
}

// ==========================================
// 3. æŸ¥è©¢èˆ‡ UI é‚è¼¯
// ==========================================

// å…±ç”¨æœå°‹ Helper
function findCB(keyword) {
    const db = AppState.data.basic;
    const hl = AppState.data.highLow;
    
    // 1. ç²¾ç¢ºä»£è™Ÿ
    if (db[keyword]) return { code: keyword, ...db[keyword], ...hl[keyword] };
    
    // 2. åç¨±æ¨¡ç³Šæœå°‹
    for (let code in db) {
        if (db[code]['åç¨±'] && db[code]['åç¨±'].includes(keyword)) {
            return { code, ...db[code], ...hl[code] };
        }
        // ç›¸å®¹ 00 æª”æ¬„ä½å
        if (db[code]['CBåç¨±'] && db[code]['CBåç¨±'].includes(keyword)) {
            return { code, ...db[code], ...hl[code] };
        }
    }
    return null;
}

// P2: é«˜ä½æŸ¥è©¢
function searchHighLow() {
    const val = document.getElementById('hlInput').value.trim();
    if (!val) return alert('è«‹è¼¸å…¥ä»£è™Ÿ');
    if (Object.keys(AppState.data.highLow).length === 0) return alert('è«‹å…ˆè¼‰å…¥æª”æ¡ˆ 00');

    const res = findCB(val);
    const card = document.getElementById('hlResult');
    
    if (res) {
        document.getElementById('hlName').innerText = `${res['åç¨±'] || res['CBåç¨±']} (${res.code})`;
        document.getElementById('hlHigh').innerText = res.high || '--';
        document.getElementById('hlLow').innerText = res.low || '--';
        
        let amp = '--';
        if(res.high && res.low) amp = ((res.high - res.low)/res.low * 100).toFixed(2) + '%';
        document.getElementById('hlAmp').innerText = amp;
        
        document.getElementById('hlAvg').innerText = res.avgBid || '--';
        card.style.display = 'block';
    } else {
        alert('æŸ¥ç„¡è³‡æ–™');
        card.style.display = 'none';
    }
}

function updateHighLowRanking() {
    const list = [];
    const db = AppState.data.highLow;
    for(let c in db) {
        if(db[c].high && db[c].low) {
            const amp = (db[c].high - db[c].low) / db[c].low;
            list.push({ code: c, name: db[c].name, amp: amp });
        }
    }
    list.sort((a,b) => b.amp - a.amp); // é™åº
    
    const html = list.slice(0, 20).map((item, idx) => `
        <div class="list-item" onclick="document.getElementById('hlInput').value='${item.code}';searchHighLow()">
            <div>${idx+1}. ${item.name} <span style="color:#999;font-size:12px">${item.code}</span></div>
            <div style="color:#1a73e8;font-weight:bold">${(item.amp*100).toFixed(1)}%</div>
        </div>
    `).join('');
    
    document.getElementById('hlRanking').innerHTML = html || '<div style="padding:10px;text-align:center">ç„¡è³‡æ–™</div>';
}

// P3: ç™¼è¡ŒæŸ¥è©¢
function searchIssue() {
    const val = document.getElementById('issueInput').value.trim();
    const res = findCB(val);
    const div = document.getElementById('issueResult');
    
    if (res) {
        div.innerHTML = `
            <h3>${res['åç¨±'] || res['CBåç¨±']} (${res.code})</h3>
            <div class="list-item"><span>ç™¼è¡Œç¸½é¡</span><span>${res['ç™¼è¡Œç¸½é¡'] || res['ç™¼è¡Œé‡‘é¡'] || '--'} å„„</span></div>
            <div class="list-item"><span>ç™¼è¡Œæ—¥æœŸ</span><span>${res['ç™¼è¡Œæ—¥æœŸ'] || '--'}</span></div>
            <div class="list-item"><span>è½‰æ›åƒ¹æ ¼</span><span>${res['è½‰æ›åƒ¹æ ¼'] || '--'}</span></div>
            <div class="list-item"><span>ç™¼è¡Œæ–¹å¼</span><span>${res['ç™¼è¡Œæ–¹å¼'] || res['æ–¹å¼'] || '--'}</span></div>
        `;
        div.style.display = 'block';
    } else {
        alert('æŸ¥ç„¡è³‡æ–™');
    }
}

// P4: åŒå…¬å¸æŸ¥è©¢
function searchCompany() {
    const val = document.getElementById('compInput').value.trim();
    if(!val) return;
    
    const db = AppState.data.basic;
    const results = [];
    
    for(let c in db) {
        // ç°¡å–®éæ¿¾ï¼šå¦‚æœåç¨±åŒ…å«è¼¸å…¥å€¼ (éœ€æ’é™¤ "ä¸€", "äºŒ" ç­‰å¾Œç¶´ä¾†æŠ“ä¸»å…¬å¸åæ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡å…ˆåšç°¡å–®åŒ…å«)
        if ((db[c]['åç¨±'] && db[c]['åç¨±'].includes(val)) || (db[c]['è‚¡ç¥¨ä»£è™Ÿ'] == val)) {
            results.push({ code: c, name: db[c]['åç¨±'] });
        }
    }
    
    const html = results.map(item => `
        <div class="list-item">
            <div>${item.name}</div>
            <div>${item.code}</div>
        </div>
    `).join('');
    
    document.getElementById('compResult').innerHTML = html || '<div style="padding:20px;text-align:center">æŸ¥ç„¡ç›¸é—œç™¼è¡Œ</div>';
}

// P5: ç«¶æ‹æŸ¥è©¢
function searchAuction() {
    const val = document.getElementById('aucInput').value.trim();
    const aucDb = AppState.data.auction;
    
    // æ‰¾ä»£è™Ÿ
    let targetCode = val;
    // å¦‚æœä¸æ˜¯ä»£è™Ÿï¼Œå˜—è©¦å¾ Basic è½‰ä»£è™Ÿ
    if (!aucDb[targetCode]) {
        const basicInfo = findCB(val);
        if (basicInfo) targetCode = basicInfo.code;
    }

    const res = aucDb[targetCode];
    if(res) {
        document.getElementById('aucResult').innerHTML = `
             <h3>${res['åç¨±'] || res['CBåç¨±']} (${targetCode})</h3>
             <div class="result-grid">
                <div class="result-item"><div class="result-label">å¹³å‡å¾—æ¨™</div><div class="result-value red">${parseFloat(res['å¹³å‡å¾—æ¨™']||0).toFixed(2)}</div></div>
                <div class="result-item"><div class="result-label">æœ€ä½å¾—æ¨™</div><div class="result-value">${parseFloat(res['æœ€ä½å¾—æ¨™']||0).toFixed(2)}</div></div>
                <div class="result-item"><div class="result-label">å¾—æ¨™å€æ•¸</div><div class="result-value blue">${res['æŠ•æ¨™å€æ•¸'] || '--'}</div></div>
                <div class="result-item"><div class="result-label">ç¸½åˆæ ¼ä»¶</div><div class="result-value">${res['åˆæ ¼ä»¶æ•¸'] || '--'}</div></div>
             </div>
        `;
        document.getElementById('aucResult').style.display = 'block';
    } else {
        alert('æŸ¥ç„¡ç«¶æ‹è³‡æ–™ (è«‹ç¢ºèªæ˜¯å¦è¼‰å…¥ 00 æª”)');
    }
}

// P6: ç”¢æ¥­æ¦‚å¿µ
function searchIndustry() {
    const val = document.getElementById('indInput').value.trim();
    const res = AppState.data.industry[val] || findCB(val); // å˜—è©¦æ‰¾ CB å†æ‰¾ç”¢æ¥­
    const div = document.getElementById('indResult');
    
    if (res) {
        // å–å¾—è©²å…¬å¸çš„ä»£è™Ÿ (å¦‚æœæ˜¯å¾ industry ç›´æ¥æ‹¿åˆ°å°±æœ‰ä»£è™Ÿï¼Œå¦‚æœæ˜¯å¾ findCB æ‹¿åˆ°ä¹Ÿæœ‰)
        const stockCode = res['è‚¡ç¥¨ä»£è™Ÿ'] || res['ä»£è™Ÿ'] || (res.code ? res.code.substring(0,4) : '');
        const indInfo = AppState.data.industry[stockCode] || {};
        const concepts = AppState.data.concepts[stockCode] || [];
        
        let conceptHtml = concepts.map(c => `<span style="background:#eee;padding:4px 8px;border-radius:4px;font-size:12px;margin:2px;">${c['æ¦‚å¿µåˆ†é¡']}</span>`).join('');

        div.innerHTML = `
            <h3>${res['åç¨±'] || indInfo['åç¨±'] || val}</h3>
            <p><strong>ç”¢æ¥­ï¼š</strong> ${indInfo['ç”¢æ¥­'] || '--'} > ${indInfo['ç´°ç”¢æ¥­'] || '--'}</p>
            <p><strong>åœ°ä½ï¼š</strong> ${indInfo['ç”¢æ¥­åœ°ä½'] || '--'}</p>
            <div style="margin-top:10px; display:flex; flex-wrap:wrap;">${conceptHtml}</div>
        `;
        div.style.display = 'block';
    } else {
        alert('æŸ¥ç„¡ç”¢æ¥­è³‡æ–™');
    }
}

// ==========================================
// 4. é é¢æ§åˆ¶
// ==========================================
function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('active');
    document.getElementById('overlay').classList.toggle('active');
}
function closeMenu() {
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
}
function showPage(pageId) {
    closeMenu();
    document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
    document.getElementById(`page-${pageId}`).classList.add('active');
    
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
    // ç°¡å–® highlight ç•¶å‰ menu (å¯ä¾éœ€æ±‚å„ªåŒ–)
}

// åˆå§‹åŒ–
window.onload = function() {
    setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
    }, 800);
};
</script>
</body>
</html>
