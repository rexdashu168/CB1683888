<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”168 CBç³»çµ± v6.0 - Excelè³‡æ–™æ•´åˆç‰ˆ</title>
    <!-- å¼•å…¥å¿…è¦çš„å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }

```
    /* è¼‰å…¥ç•«é¢ */
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-text {
        font-size: 1.2em;
        margin-bottom: 10px;
    }
    .loading-status {
        font-size: 0.9em;
        color: #ccc;
    }
    
    /* éŒ¯èª¤è¨Šæ¯ */
    .error-message {
        background: #ff4444;
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px;
        text-align: center;
        max-width: 600px;
    }
    
    .rex-home { max-width: 800px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
    .rex-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 40px 20px 30px; text-align: center; color: white; }
    .rex-logo { font-size: 4em; margin-bottom: 15px; }
    .rex-title { font-size: 1.8em; font-weight: 700; margin-bottom: 10px; }
    .rex-subtitle { font-size: 1em; opacity: 0.95; margin-bottom: 15px; }
    .rex-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; }
    
    .stats-container { background: white; margin: 0 20px 20px; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .stats-title { font-size: 1.2em; font-weight: 600; color: #1e3c72; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-item { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 12px 8px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 8px; }
    .stat-icon { font-size: 1.8em; }
    .stat-info { width: 100%; }
    .stat-label { font-size: 0.75em; color: #666; margin-bottom: 5px; }
    .stat-value { font-size: 1.3em; font-weight: 700; color: #667eea; }
    
    .search-area { padding: 0 20px 20px; }
    .search-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .search-card-title { font-size: 1.2em; font-weight: 600; color: #1e3c72; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
    .search-input-group { position: relative; margin-bottom: 15px; }
    .search-input { width: 100%; padding: 15px 60px 15px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1.05em; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .search-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .search-hint { font-size: 0.85em; color: #999; margin-bottom: 15px; }
    
    .data-status { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85em; }
    .status-ok { color: #52c41a; }
    .status-error { color: #ff4444; }
    
    .quick-examples { background: #f8f9fa; padding: 15px; border-radius: 10px; }
    .quick-title { font-size: 0.9em; font-weight: 600; color: #555; margin-bottom: 10px; }
    .chip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .chip { background: white; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #e0e0e0; transition: all 0.3s; text-align: center; font-size: 0.9em; }
    .chip:hover { background: #667eea; color: white; transform: translateY(-2px); }
    .chip-label { font-size: 0.75em; color: #999; display: block; }
    .chip:hover .chip-label { color: rgba(255,255,255,0.8); }
    
    .rex-footer { margin-top: auto; padding: 30px 20px; text-align: center; color: white; opacity: 0.9; }
    
    .detail-screen { display: none; max-width: 800px; margin: 0 auto; background: #f5f5f5; min-height: 100vh; overflow-y: auto; }
    .detail-screen.active { display: block; position: relative; }
    .detail-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; }
    .detail-back { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
    .detail-title-area { display: flex; justify-content: space-between; align-items: center; }
    .detail-main-title { font-size: 1.6em; font-weight: 700; }
    .detail-subtitle { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
    .detail-price { font-size: 1.8em; font-weight: 700; }
    
    .detail-content { padding: 15px; }
    .tab-nav { background: white; display: flex; border-radius: 12px; margin-bottom: 15px; overflow-x: auto; }
    .tab-btn { flex: 1; min-width: 80px; padding: 15px 10px; border: none; background: white; font-weight: 600; cursor: pointer; color: #666; font-size: 0.9em; white-space: nowrap; }
    .tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .info-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .card-title { font-size: 1.2em; font-weight: 600; color: #1e3c72; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
    .info-row { display: flex; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .info-row:last-child { border-bottom: none; }
    .info-label { flex: 0 0 120px; font-weight: 600; color: #555; font-size: 0.95em; }
    .info-value { flex: 1; color: #333; font-size: 0.95em; }
    
    .time-range-btns { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .time-btn { padding: 8px 15px; border: 1px solid #e0e0e0; border-radius: 6px; background: white; cursor: pointer; font-size: 0.9em; }
    .time-btn.active { background: #667eea; color: white; border-color: #667eea; }
    
    .chart-container { width: 100%; height: 450px; position: relative; }
    .chart-box { width: 100% !important; height: 100% !important; }
    
    .highlight-green { color: #52c41a; font-weight: 600; }
    .highlight-blue { color: #1890ff; font-weight: 600; }
    .highlight-orange { color: #ff9800; font-weight: 600; }
    .highlight-purple { color: #9c27b0; font-weight: 600; }
    
    .info-highlight { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107; }
    .info-highlight-title { font-weight: 600; color: #856404; margin-bottom: 8px; font-size: 1.05em; }
    
    .data-table { width: 100%; overflow-x: auto; }
    .data-table table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .data-table th { background: #f5f5f5; padding: 10px 8px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; }
    .data-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .data-table tr:hover { background: #fafafa; }
    
    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat-item { padding: 10px 5px; }
        .stat-icon { font-size: 1.5em; }
        .stat-label { font-size: 0.65em; }
        .stat-value { font-size: 1.1em; }
        .chip-grid { grid-template-columns: 1fr; }
    }
</style>
```

</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
        <div class="loading-status" id="loadingStatus">åˆå§‹åŒ–ç³»çµ±</div>
    </div>

```
<div id="home" class="rex-home" style="display:none;">
    <div class="rex-header">
        <div class="rex-logo">ğŸ“ˆ</div>
        <h1 class="rex-title">Rexå¤§å”168<br>CBæ™ºèƒ½æŸ¥è©¢ç³»çµ±</h1>
        <p class="rex-subtitle">å°ˆæ³¨é¢¨éšª â€¢ æ•¸æ“šé©…å‹• â€¢ æ™ºèƒ½åˆ†æ<br>æ•´åˆExcelè³‡æ–™åº« â€¢ å³æ™‚æ›´æ–°</p>
        <div class="rex-badge">ğŸ¯ v6.0 Excelè³‡æ–™æ•´åˆç‰ˆ</div>
    </div>
    
    <div class="stats-container">
        <div class="stats-title">ğŸ“Š è³‡æ–™åº«çµ±è¨ˆ</div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-info">
                    <div class="stat-label">CBç¸½æ•¸</div>
                    <div class="stat-value" id="totalCB">--</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">ğŸ’</div>
                <div class="stat-info">
                    <div class="stat-label">CBASæœˆä»½</div>
                    <div class="stat-value" id="cbasMonths">--</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-info">
                    <div class="stat-label">åƒ¹æ ¼æœˆä»½</div>
                    <div class="stat-value" id="priceMonths">--</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="search-area">
        <div class="search-card">
            <div class="search-card-title">ğŸ” æ™ºèƒ½æœå°‹</div>
            <div class="data-status" id="dataStatus">
                <span id="statusText">æª¢æŸ¥è³‡æ–™ç‹€æ…‹ä¸­...</span>
            </div>
            <div class="search-input-group">
                <input type="text" class="search-input" id="cbInput" placeholder="è¼¸å…¥CBä»£è™Ÿã€è‚¡ç¥¨ä»£è™Ÿæˆ–å…¬å¸åç¨±..." onkeypress="if(event.key==='Enter') smartSearch()">
                <button class="search-btn" onclick="smartSearch()">æœå°‹</button>
            </div>
            <div class="search-hint">ğŸ’¡ æ”¯æ´: CBä»£è™Ÿ(å¦‚:11011) / è‚¡ç¥¨ä»£è™Ÿ(å¦‚:1101) / å…¬å¸åç¨±(å¦‚:å°æ³¥)</div>
            <div class="quick-examples" id="quickExamples" style="display:none;">
                <div class="quick-title">âš¡ å¿«é€Ÿæ¸¬è©¦</div>
                <div class="chip-grid" id="quickChips">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="rex-footer">
        <strong>Rexå¤§å”çš„æŠ•è³‡ç†å¿µ</strong><br>
        <small style="margin-top:10px;display:block;">å°ˆæ³¨æ–¼é¢¨éšªï¼Œä¸è¿½æ±‚å ±é…¬<br>å¾æ•¸æ“šä¸­å­¸ç¿’ï¼Œç”¨æ™ºæ…§æŠ•è³‡</small>
        <small style="margin-top:15px;display:block;opacity:0.8;">Â© 2025 Rexå¤§å”168 â€¢ Excelè³‡æ–™æ•´åˆç‰ˆ</small>
    </div>
</div>

<div id="detail" class="detail-screen">
    <div class="detail-header">
        <button class="detail-back" onclick="backToHome()">â† è¿”å›</button>
        <div class="detail-title-area">
            <div>
                <div class="detail-main-title" id="detailTitle">è¼‰å…¥ä¸­...</div>
                <div class="detail-subtitle" id="detailSubtitle">...</div>
            </div>
            <div class="detail-price" id="detailPrice">--</div>
        </div>
    </div>
    <div class="detail-content">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('basic')">åŸºæœ¬è³‡æ–™</button>
            <button class="tab-btn" onclick="switchTab('price')">CBåƒ¹æ ¼èµ°å‹¢</button>
            <button class="tab-btn" onclick="switchTab('cbas')">CBASèµ°å‹¢</button>
            <button class="tab-btn" onclick="switchTab('table')">æ­·å²è³‡æ–™è¡¨</button>
        </div>
        <div id="tab-basic" class="tab-content active">
            <div id="basicContent"></div>
        </div>
        <div id="tab-price" class="tab-content">
            <div class="info-card">
                <div class="card-title">ğŸ“ˆ CBæœˆæˆäº¤åƒ¹èµ°å‹¢</div>
                <div class="time-range-btns">
                    <button class="time-btn" onclick="changeRange('price', 3)">3å€‹æœˆ</button>
                    <button class="time-btn" onclick="changeRange('price', 6)">6å€‹æœˆ</button>
                    <button class="time-btn active" onclick="changeRange('price', 12)">1å¹´</button>
                    <button class="time-btn" onclick="changeRange('price', 999)">å…¨éƒ¨</button>
                </div>
                <div class="chart-container"><div id="chartPrice" class="chart-box"></div></div>
            </div>
        </div>
        <div id="tab-cbas" class="tab-content">
            <div class="info-card">
                <div class="card-title">ğŸ’ CBASæ¬Šåˆ©é‡‘èµ°å‹¢</div>
                <div class="time-range-btns">
                    <button class="time-btn" onclick="changeRange('cbas', 3)">3å€‹æœˆ</button>
                    <button class="time-btn" onclick="changeRange('cbas', 6)">6å€‹æœˆ</button>
                    <button class="time-btn active" onclick="changeRange('cbas', 12)">1å¹´</button>
                    <button class="time-btn" onclick="changeRange('cbas', 999)">å…¨éƒ¨</button>
                </div>
                <div class="chart-container"><div id="chartCBAS" class="chart-box"></div></div>
            </div>
        </div>
        <div id="tab-table" class="tab-content">
            <div id="tableContent"></div>
        </div>
    </div>
</div>
```

<script>
// å…¨åŸŸè®Šæ•¸
let cbDatabase = {};        // 00_CBä»£è™Ÿåç¨±
let cbasData = {};         // CBASæœˆæ‹†è§£è³‡æ–™
let priceData = {};        // CBæœˆæˆäº¤åƒ¹è³‡æ–™
let availableMonths = {    // å¯ç”¨æœˆä»½
    cbas: [],
    price: []
};
let currentCB = null;
let priceChart = null;
let cbasChart = null;

// è¨­å®šæª” - GitHub ä¸Šçš„ Excel æª”æ¡ˆè·¯å¾‘
const CONFIG = {
    // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› GitHub æª”æ¡ˆè·¯å¾‘
    baseUrl: './',  // å¦‚æœéƒ¨ç½²åœ¨GitHub Pagesï¼Œæ”¹ç‚º 'https://YOUR-USERNAME.github.io/YOUR-REPO/'
    
    cbFile: '00_CBä»£è™Ÿåç¨±.xlsx',
    cbasFile: 'CBASæœˆæ‹†è§£æŸ¥è©¢ç³»çµ±_è³‡æ–™ç‰ˆ.xlsx',
    priceFile: '04_CBæœˆæˆäº¤åƒ¹è¡¨_1_.xlsx'
};

// è¼‰å…¥ Excel æª”æ¡ˆ
async function loadExcelFile(url) {
    try {
        updateLoadingStatus(`æ­£åœ¨è¼‰å…¥ ${url.split('/').pop()}...`);
        const response = await axios.get(url, { responseType: 'arraybuffer' });
        const data = new Uint8Array(response.data);
        const workbook = XLSX.read(data, { type: 'array' });
        return workbook;
    } catch (error) {
        console.error(`è¼‰å…¥æª”æ¡ˆå¤±æ•—: ${url}`, error);
        throw error;
    }
}

// è™•ç† 00_CBä»£è™Ÿåç¨±.xlsx
function processCBFile(workbook) {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    const database = {};
    jsonData.forEach(row => {
        if (row['ä»£è™Ÿ']) {
            const cbCode = String(row['ä»£è™Ÿ']).padStart(5, '0');
            database[cbCode] = {
                cb_code: cbCode,
                stock_code: String(row['è‚¡ç¥¨ä»£è™Ÿ'] || ''),
                name: row['åç¨±'] || '',
                high_price: parseFloat(row['æ›ç‰Œæœ€é«˜']) || 0,
                low_price: parseFloat(row['æ›ç‰Œæœ€ä½']) || 0,
                purpose: row['è³‡é‡‘ç”¨é€”'] || ''
            };
        }
    });
    
    return database;
}

// è™•ç† CBASæœˆæ‹†è§£æŸ¥è©¢ç³»çµ±
function processCBASFile(workbook) {
    const data = {};
    const months = [];
    
    // è·³éç¬¬ä¸€å€‹ç¸½è¡¨ï¼Œå¾æœˆä»½å·¥ä½œè¡¨é–‹å§‹
    for (let i = 1; i < workbook.SheetNames.length; i++) {
        const sheetName = workbook.SheetNames[i];
        months.push(sheetName);
        
        const worksheet = workbook.Sheets[sheetName];
        // CBASè³‡æ–™å¾ç¬¬4è¡Œé–‹å§‹ï¼ˆå‰3è¡Œæ˜¯æ¨™é¡Œï¼‰
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 3 });
        
        const monthData = {};
        jsonData.forEach(row => {
            if (row[0] && !isNaN(row[0])) {  // ç¢ºä¿æ˜¯CBä»£è™Ÿ
                const cbCode = String(row[0]).padStart(5, '0');
                monthData[cbCode] = {
                    name: row[1] || '',
                    notional: parseFloat(row[2]) || 0,
                    transactions: parseInt(row[3]) || 0,
                    premium_high: parseFloat(row[4]) || 0,
                    premium_low: parseFloat(row[5]) || 0,
                    premium_avg: parseFloat(row[6]) || 0,
                    term: parseFloat(row[7]) || 0
                };
            }
        });
        
        data[sheetName] = monthData;
    }
    
    return { data, months };
}

// è™•ç† CBæœˆæˆäº¤åƒ¹è¡¨
function processPriceFile(workbook) {
    const data = {};
    const months = [];
    
    // è·³éç¬¬ä¸€å€‹ç¸½è¡¨
    for (let i = 1; i < workbook.SheetNames.length; i++) {
        const sheetName = workbook.SheetNames[i];
        months.push(sheetName);
        
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        const monthData = {};
        jsonData.forEach(row => {
            if (row['ä»£è™Ÿ']) {
                const cbCode = String(row['ä»£è™Ÿ']).padStart(5, '0');
                monthData[cbCode] = {
                    name: row['åç¨±'] || '',
                    volume: parseInt(row['æˆäº¤é‡']) || 0,
                    amount: parseFloat(row['æˆäº¤é‡‘é¡']) || 0,
                    transactions: parseInt(row['æˆäº¤ç­†æ•¸']) || 0,
                    avg_price: parseFloat(row['å¹³å‡']) || 0,
                    high_price: parseFloat(row['æœ€é«˜']) || 0,
                    low_price: parseFloat(row['æœ€ä½']) || 0
                };
            }
        });
        
        data[sheetName] = monthData;
    }
    
    return { data, months };
}

// æ›´æ–°è¼‰å…¥ç‹€æ…‹
function updateLoadingStatus(text) {
    const statusElement = document.getElementById('loadingStatus');
    if (statusElement) {
        statusElement.textContent = text;
    }
}

// åˆå§‹åŒ–ç³»çµ±
async function initializeSystem() {
    try {
        // è¼‰å…¥ CB åŸºæœ¬è³‡æ–™
        updateLoadingStatus('è¼‰å…¥CBåŸºæœ¬è³‡æ–™...');
        const cbWorkbook = await loadExcelFile(CONFIG.baseUrl + CONFIG.cbFile);
        cbDatabase = processCBFile(cbWorkbook);
        
        // è¼‰å…¥ CBAS è³‡æ–™
        updateLoadingStatus('è¼‰å…¥CBASè³‡æ–™...');
        const cbasWorkbook = await loadExcelFile(CONFIG.baseUrl + CONFIG.cbasFile);
        const cbasResult = processCBASFile(cbasWorkbook);
        cbasData = cbasResult.data;
        availableMonths.cbas = cbasResult.months;
        
        // è¼‰å…¥åƒ¹æ ¼è³‡æ–™
        updateLoadingStatus('è¼‰å…¥CBåƒ¹æ ¼è³‡æ–™...');
        const priceWorkbook = await loadExcelFile(CONFIG.baseUrl + CONFIG.priceFile);
        const priceResult = processPriceFile(priceWorkbook);
        priceData = priceResult.data;
        availableMonths.price = priceResult.months;
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        updateStatistics();
        
        // ç”Ÿæˆå¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
        generateQuickButtons();
        
        // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»ç•«é¢
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('home').style.display = 'flex';
        
        // æ›´æ–°è³‡æ–™ç‹€æ…‹
        updateDataStatus(true);
        
    } catch (error) {
        console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
        document.getElementById('loadingScreen').innerHTML = `
            <div class="error-message">
                <h2>è¼‰å…¥å¤±æ•—</h2>
                <p>ç„¡æ³•è¼‰å…¥ Excel è³‡æ–™æª”æ¡ˆ</p>
                <p>è«‹ç¢ºèªæª”æ¡ˆè·¯å¾‘æ­£ç¢ºï¼š</p>
                <ul style="text-align:left;">
                    <li>${CONFIG.cbFile}</li>
                    <li>${CONFIG.cbasFile}</li>
                    <li>${CONFIG.priceFile}</li>
                </ul>
                <p>éŒ¯èª¤è¨Šæ¯ï¼š${error.message}</p>
                <p style="margin-top:20px;">æç¤ºï¼šå¦‚æœæ˜¯åœ¨æœ¬åœ°æ¸¬è©¦ï¼Œè«‹ä½¿ç”¨ Live Server æˆ–é¡ä¼¼å·¥å…·é¿å… CORS éŒ¯èª¤</p>
            </div>
        `;
    }
}

// æ›´æ–°çµ±è¨ˆè³‡è¨Š
function updateStatistics() {
    document.getElementById('totalCB').textContent = Object.keys(cbDatabase).length + 'æª”';
    document.getElementById('cbasMonths').textContent = availableMonths.cbas.length + 'æœˆ';
    document.getElementById('priceMonths').textContent = availableMonths.price.length + 'æœˆ';
}

// æ›´æ–°è³‡æ–™ç‹€æ…‹
function updateDataStatus(success) {
    const statusElement = document.getElementById('dataStatus');
    const statusText = document.getElementById('statusText');
    
    if (success) {
        statusElement.style.background = '#f0fff0';
        statusText.innerHTML = '<span class="status-ok">âœ“ è³‡æ–™è¼‰å…¥å®Œæˆ</span>';
    } else {
        statusElement.style.background = '#fff0f0';
        statusText.innerHTML = '<span class="status-error">âœ— è³‡æ–™è¼‰å…¥å¤±æ•—</span>';
    }
}

// ç”Ÿæˆå¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
function generateQuickButtons() {
    const container = document.getElementById('quickChips');
    const examplesDiv = document.getElementById('quickExamples');
    
    // é¸å–ä¸€äº›æœ‰è¶£çš„CBä½œç‚ºç¯„ä¾‹
    const examples = [
        { code: '11011', info: cbDatabase['11011'] },
        { code: '12561', info: cbDatabase['12561'] },
        { code: '13166', info: cbDatabase['13166'] },
        { code: '14664', info: cbDatabase['14664'] }
    ].filter(item => item.info);
    
    if (examples.length > 0) {
        container.innerHTML = examples.map(item => `
            <div class="chip" onclick="quickSearch('${item.code}')">
                <strong>${item.code}</strong><br>
                <span class="chip-label">${item.info.name}</span>
            </div>
        `).join('');
        
        examplesDiv.style.display = 'block';
    }
}

// æ™ºèƒ½æœå°‹
function smartSearch() {
    const input = document.getElementById('cbInput').value.trim();
    if (!input) {
        alert('è«‹è¼¸å…¥æŸ¥è©¢æ¢ä»¶');
        return;
    }
    
    let cbCode = null;
    
    // ç›´æ¥CBä»£è™Ÿï¼ˆå¯èƒ½éœ€è¦è£œé›¶ï¼‰
    const paddedInput = input.padStart(5, '0');
    if (cbDatabase[paddedInput]) {
        cbCode = paddedInput;
    }
    // è‚¡ç¥¨ä»£è™Ÿ
    else if (/^\d{4}$/.test(input)) {
        for (let code in cbDatabase) {
            if (cbDatabase[code].stock_code === input) {
                cbCode = code;
                break;
            }
        }
    }
    // å…¬å¸åç¨±æœå°‹
    else {
        for (let code in cbDatabase) {
            if (cbDatabase[code].name.includes(input)) {
                cbCode = code;
                break;
            }
        }
    }
    
    if (cbCode) {
        loadCBDetail(cbCode);
    } else {
        alert('æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥æ­£ç¢º');
    }
}

// å¿«é€Ÿæœå°‹
function quickSearch(code) {
    document.getElementById('cbInput').value = code;
    smartSearch();
}

// è¼‰å…¥CBè©³ç´°è³‡æ–™
function loadCBDetail(code) {
    const cb = cbDatabase[code];
    if (!cb) return;
    
    currentCB = code;
    
    // å–å¾—æœ€æ–°æœˆä»½çš„åƒ¹æ ¼è³‡æ–™
    const latestPriceMonth = availableMonths.price[availableMonths.price.length - 1];
    const latestPrice = priceData[latestPriceMonth]?.[code];
    
    // æ›´æ–°æ¨™é¡Œ
    document.getElementById('detailTitle').textContent = `${cb.name} (${code})`;
    document.getElementById('detailSubtitle').textContent = `æ¨™çš„: ${cb.stock_code}`;
    document.getElementById('detailPrice').textContent = latestPrice ? latestPrice.avg_price.toFixed(2) : '--';
    
    // è¼‰å…¥å„é …è³‡æ–™
    loadBasicInfo(cb);
    loadPriceChart(code);
    loadCBASChart(code);
    loadHistoryTable(code);
    
    // åˆ‡æ›ç•«é¢
    document.getElementById('home').style.display = 'none';
    document.getElementById('detail').classList.add('active');
}

// è¼‰å…¥åŸºæœ¬è³‡æ–™
function loadBasicInfo(cb) {
    let html = `
        <div class="info-card">
            <div class="card-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
            <div class="info-row"><div class="info-label">CBä»£è™Ÿ</div><div class="info-value"><span class="highlight-blue">${cb.cb_code}</span></div></div>
            <div class="info-row"><div class="info-label">è‚¡ç¥¨ä»£è™Ÿ</div><div class="info-value">${cb.stock_code || '--'}</div></div>
            <div class="info-row"><div class="info-label">CBåç¨±</div><div class="info-value">${cb.name || '--'}</div></div>
            <div class="info-row"><div class="info-label">æ›ç‰Œæœ€é«˜</div><div class="info-value"><span class="highlight-green">${cb.high_price || '--'}å…ƒ</span></div></div>
            <div class="info-row"><div class="info-label">æ›ç‰Œæœ€ä½</div><div class="info-value"><span class="highlight-orange">${cb.low_price || '--'}å…ƒ</span></div></div>
    `;
    
    if (cb.purpose) {
        html += `<div class="info-row"><div class="info-label">è³‡é‡‘ç”¨é€”</div><div class="info-value">${cb.purpose}</div></div>`;
    }
    
    html += `</div>`;
    
    // æœ€æ–°äº¤æ˜“è³‡è¨Š
    const latestPriceMonth = availableMonths.price[availableMonths.price.length - 1];
    const latestPrice = priceData[latestPriceMonth]?.[cb.cb_code];
    
    if (latestPrice) {
        html += `
        <div class="info-card">
            <div class="card-title">ğŸ“Š æœ€æ–°äº¤æ˜“è³‡è¨Š (${formatMonth(latestPriceMonth)})</div>
            <div class="info-row"><div class="info-label">å¹³å‡åƒ¹</div><div class="info-value"><span class="highlight-blue">${latestPrice.avg_price.toFixed(2)}å…ƒ</span></div></div>
            <div class="info-row"><div class="info-label">æœ€é«˜åƒ¹</div><div class="info-value">${latestPrice.high_price.toFixed(2)}å…ƒ</div></div>
            <div class="info-row"><div class="info-label">æœ€ä½åƒ¹</div><div class="info-value">${latestPrice.low_price.toFixed(2)}å…ƒ</div></div>
            <div class="info-row"><div class="info-label">æˆäº¤é‡</div><div class="info-value">${latestPrice.volume.toLocaleString()}å¼µ</div></div>
            <div class="info-row"><div class="info-label">æˆäº¤é‡‘é¡</div><div class="info-value">${(latestPrice.amount/10000).toFixed(2)}è¬å…ƒ</div></div>
            <div class="info-row"><div class="info-label">æˆäº¤ç­†æ•¸</div><div class="info-value">${latestPrice.transactions}ç­†</div></div>
        </div>`;
    }
    
    // æœ€æ–°CBASè³‡è¨Š
    const latestCBASMonth = availableMonths.cbas[availableMonths.cbas.length - 1];
    const latestCBAS = cbasData[latestCBASMonth]?.[cb.cb_code];
    
    if (latestCBAS) {
        html += `
        <div class="info-card">
            <div class="card-title">ğŸ’ æœ€æ–°CBASè³‡è¨Š (${formatMonth(latestCBASMonth)})</div>
            <div class="info-row"><div class="info-label">æ¬Šåˆ©é‡‘å¹³å‡</div><div class="info-value"><span class="highlight-purple">${latestCBAS.premium_avg.toFixed(4)}å…ƒ</span></div></div>
            <div class="info-row"><div class="info-label">æ¬Šåˆ©é‡‘æœ€é«˜</div><div class="info-value">${latestCBAS.premium_high.toFixed(4)}å…ƒ</div></div>
            <div class="info-row"><div class="info-label">æ¬Šåˆ©é‡‘æœ€ä½</div><div class="info-value">${latestCBAS.premium_low.toFixed(4)}å…ƒ</div></div>
            <div class="info-row"><div class="info-label">æˆäº¤ç­†æ•¸</div><div class="info-value">${latestCBAS.transactions}ç­†</div></div>
            <div class="info-row"><div class="info-label">åç›®æœ¬é‡‘</div><div class="info-value">${(latestCBAS.notional/10000).toFixed(2)}è¬å…ƒ</div></div>
            <div class="info-row"><div class="info-label">å¥‘ç´„æœŸé–“</div><div class="info-value">${latestCBAS.term}å¹´</div></div>
        </div>`;
    }
    
    document.getElementById('basicContent').innerHTML = html;
}

// è¼‰å…¥åƒ¹æ ¼èµ°å‹¢åœ–
function loadPriceChart(code) {
    const chartData = [];
    const volumes = [];
    
    availableMonths.price.forEach(month => {
        const monthData = priceData[month]?.[code];
        if (monthData) {
            chartData.push({
                date: formatMonth(month),
                price: monthData.avg_price,
                volume: monthData.volume,
                high: monthData.high_price,
                low: monthData.low_price
            });
        }
    });
    
    if (chartData.length === 0) {
        document.getElementById('chartPrice').innerHTML = '<div style="text-align:center;padding:50px;color:#999;">ç„¡åƒ¹æ ¼è³‡æ–™</div>';
        return;
    }
    
    updatePriceChart(chartData, 12);
}

// æ›´æ–°åƒ¹æ ¼åœ–è¡¨
function updatePriceChart(data, months) {
    const displayData = months === 999 ? data : data.slice(-months);
    
    if (!priceChart) {
        priceChart = echarts.init(document.getElementById('chartPrice'));
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
        },
        grid: {
            left: 60,
            right: 60,
            bottom: 60,
            top: 40
        },
        xAxis: {
            type: 'category',
            data: displayData.map(d => d.date),
            axisLabel: {
                rotate: 45,
                fontSize: 10
            }
        },
        yAxis: [
            {
                type: 'value',
                name: 'åƒ¹æ ¼',
                position: 'left',
                axisLabel: { fontSize: 10 }
            },
            {
                type: 'value',
                name: 'æˆäº¤é‡',
                position: 'right',
                axisLabel: { fontSize: 10 }
            }
        ],
        series: [
            {
                name: 'å¹³å‡åƒ¹',
                type: 'line',
                data: displayData.map(d => d.price.toFixed(2)),
                smooth: true,
                lineStyle: { width: 2, color: '#667eea' },
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: { color: '#667eea' }
            },
            {
                name: 'æˆäº¤é‡',
                type: 'bar',
                yAxisIndex: 1,
                data: displayData.map(d => d.volume),
                itemStyle: { color: 'rgba(102,126,234,0.3)' }
            }
        ]
    };
    
    priceChart.setOption(option);
}

// è¼‰å…¥CBASèµ°å‹¢åœ–
function loadCBASChart(code) {
    const chartData = [];
    
    availableMonths.cbas.forEach(month => {
        const monthData = cbasData[month]?.[code];
        if (monthData) {
            chartData.push({
                date: formatMonth(month),
                premium: monthData.premium_avg,
                transactions: monthData.transactions,
                high: monthData.premium_high,
                low: monthData.premium_low
            });
        }
    });
    
    if (chartData.length === 0) {
        document.getElementById('chartCBAS').innerHTML = '<div style="text-align:center;padding:50px;color:#999;">ç„¡CBASè³‡æ–™</div>';
        return;
    }
    
    updateCBASChart(chartData, 12);
}

// æ›´æ–°CBASåœ–è¡¨
function updateCBASChart(data, months) {
    const displayData = months === 999 ? data : data.slice(-months);
    
    if (!cbasChart) {
        cbasChart = echarts.init(document.getElementById('chartCBAS'));
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
        },
        grid: {
            left: 60,
            right: 60,
            bottom: 60,
            top: 40
        },
        xAxis: {
            type: 'category',
            data: displayData.map(d => d.date),
            axisLabel: {
                rotate: 45,
                fontSize: 10
            }
        },
        yAxis: [
            {
                type: 'value',
                name: 'æ¬Šåˆ©é‡‘',
                position: 'left',
                axisLabel: { fontSize: 10 }
            },
            {
                type: 'value',
                name: 'æˆäº¤ç­†æ•¸',
                position: 'right',
                axisLabel: { fontSize: 10 }
            }
        ],
        series: [
            {
                name: 'å¹³å‡æ¬Šåˆ©é‡‘',
                type: 'line',
                data: displayData.map(d => d.premium.toFixed(4)),
                smooth: true,
                lineStyle: { width: 3, color: '#ff9800' },
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: { color: '#ff9800' }
            },
            {
                name: 'æˆäº¤ç­†æ•¸',
                type: 'bar',
                yAxisIndex: 1,
                data: displayData.map(d => d.transactions),
                itemStyle: { color: 'rgba(255,152,0,0.3)' }
            }
        ]
    };
    
    cbasChart.setOption(option);
}

// è¼‰å…¥æ­·å²è³‡æ–™è¡¨
function loadHistoryTable(code) {
    let html = `
        <div class="info-card">
            <div class="card-title">ğŸ“Š CBæœˆæˆäº¤åƒ¹æ­·å²è³‡æ–™</div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>æœˆä»½</th>
                            <th>å¹³å‡åƒ¹</th>
                            <th>æœ€é«˜åƒ¹</th>
                            <th>æœ€ä½åƒ¹</th>
                            <th>æˆäº¤é‡</th>
                            <th>æˆäº¤é‡‘é¡(è¬)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // é¡¯ç¤ºæœ€è¿‘12å€‹æœˆçš„è³‡æ–™
    const recentMonths = availableMonths.price.slice(-12).reverse();
    recentMonths.forEach(month => {
        const data = priceData[month]?.[code];
        if (data) {
            html += `
                <tr>
                    <td>${formatMonth(month)}</td>
                    <td>${data.avg_price.toFixed(2)}</td>
                    <td>${data.high_price.toFixed(2)}</td>
                    <td>${data.low_price.toFixed(2)}</td>
                    <td>${data.volume.toLocaleString()}</td>
                    <td>${(data.amount/10000).toFixed(2)}</td>
                </tr>
            `;
        }
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-title">ğŸ’ CBASæ­·å²è³‡æ–™</div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>æœˆä»½</th>
                            <th>æ¬Šåˆ©é‡‘å¹³å‡</th>
                            <th>æ¬Šåˆ©é‡‘æœ€é«˜</th>
                            <th>æ¬Šåˆ©é‡‘æœ€ä½</th>
                            <th>æˆäº¤ç­†æ•¸</th>
                            <th>åç›®æœ¬é‡‘(è¬)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // CBASæœ€è¿‘12å€‹æœˆè³‡æ–™
    const recentCBASMonths = availableMonths.cbas.slice(-12).reverse();
    recentCBASMonths.forEach(month => {
        const data = cbasData[month]?.[code];
        if (data) {
            html += `
                <tr>
                    <td>${formatMonth(month)}</td>
                    <td>${data.premium_avg.toFixed(4)}</td>
                    <td>${data.premium_high.toFixed(4)}</td>
                    <td>${data.premium_low.toFixed(4)}</td>
                    <td>${data.transactions}</td>
                    <td>${(data.notional/10000).toFixed(2)}</td>
                </tr>
            `;
        }
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('tableContent').innerHTML = html;
}

// æ ¼å¼åŒ–æœˆä»½
function formatMonth(monthStr) {
    // å‡è¨­æ ¼å¼æ˜¯ YYMM æˆ– YYYYMM
    if (monthStr.length === 4) {
        const year = parseInt(monthStr.substring(0, 2)) + 100;  // æ°‘åœ‹å¹´è½‰è¥¿å…ƒ
        const month = monthStr.substring(2, 4);
        return `${year}/${month}`;
    } else if (monthStr.length === 5) {
        const year = parseInt(monthStr.substring(0, 3)) + 1911;  // æ°‘åœ‹å¹´è½‰è¥¿å…ƒ
        const month = monthStr.substring(3, 5);
        return `${year}/${month}`;
    }
    return monthStr;
}

// è®Šæ›´åœ–è¡¨ç¯„åœ
function changeRange(type, months) {
    event.target.parentElement.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (type === 'price') {
        loadPriceChart(currentCB);
        const chartData = [];
        availableMonths.price.forEach(month => {
            const monthData = priceData[month]?.[currentCB];
            if (monthData) {
                chartData.push({
                    date: formatMonth(month),
                    price: monthData.avg_price,
                    volume: monthData.volume
                });
            }
        });
        updatePriceChart(chartData, months);
    } else if (type === 'cbas') {
        loadCBASChart(currentCB);
        const chartData = [];
        availableMonths.cbas.forEach(month => {
            const monthData = cbasData[month]?.[currentCB];
            if (monthData) {
                chartData.push({
                    date: formatMonth(month),
                    premium: monthData.premium_avg,
                    transactions: monthData.transactions
                });
            }
        });
        updateCBASChart(chartData, months);
    }
}

// è¿”å›é¦–é 
function backToHome() {
    document.getElementById('home').style.display = 'flex';
    document.getElementById('detail').classList.remove('active');
    setTimeout(() => window.scrollTo(0, 0), 10);
}

// åˆ‡æ›æ¨™ç±¤
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
}

// éŸ¿æ‡‰å¼åœ–è¡¨èª¿æ•´
window.addEventListener('resize', () => {
    if (priceChart) priceChart.resize();
    if (cbasChart) cbasChart.resize();
});

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', initializeSystem);
</script>

</body>
</html>