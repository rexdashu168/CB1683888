<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

```
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Helvetica Neue', sans-serif; 
        background: #f5f7fa;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    /* é ‚éƒ¨å°èˆª - ä¿æŒåŸå§‹é¢¨æ ¼ */
    .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 0 15px;
        height: 55px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }
    
    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .menu-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        padding: 8px;
        cursor: pointer;
    }
    
    .header-title {
        font-size: 17px;
        font-weight: 600;
    }
    
    .header-badge {
        background: rgba(255,255,255,0.25);
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
    }
    
    /* å´é‚Šé¸å–® - ç°¡æ½”é¢¨æ ¼ */
    .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        width: 300px;
        height: 100vh;
        background: white;
        transition: left 0.3s ease;
        z-index: 2000;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar.active {
        left: 0;
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        padding: 25px 20px;
        color: white;
    }
    
    .sidebar-logo {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .sidebar-subtitle {
        font-size: 12px;
        opacity: 0.8;
    }
    
    .menu-group {
        padding: 15px 0;
    }
    
    .menu-group-title {
        padding: 8px 20px;
        font-size: 12px;
        color: #999;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .menu-item {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        cursor: pointer;
        transition: all 0.2s;
        color: #333;
        text-decoration: none;
        gap: 15px;
    }
    
    .menu-item:hover {
        background: #f8f9fa;
    }
    
    .menu-item.active {
        background: #e8f0fe;
        color: #1a73e8;
        border-left: 3px solid #1a73e8;
        padding-left: 17px;
    }
    
    .menu-icon {
        font-size: 20px;
        width: 24px;
        text-align: center;
    }
    
    .menu-text {
        font-size: 15px;
        font-weight: 500;
    }
    
    /* é®ç½©å±¤ */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 1500;
    }
    
    .overlay.active {
        display: block;
    }
    
    /* ä¸»å…§å®¹å€ */
    .main-content {
        padding-top: 55px;
        min-height: 100vh;
    }
    
    /* æœå°‹å€ - ä¿æŒåŸå§‹é¢¨æ ¼ */
    .search-container {
        background: white;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .search-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .search-subtitle {
        font-size: 14px;
        color: #666;
        margin-bottom: 12px;
    }
    
    .search-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.2s;
        margin-bottom: 15px;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
    }
    
    .search-btn {
        width: 100%;
        padding: 14px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
    }
    
    .search-hint {
        font-size: 13px;
        color: #999;
        margin-top: 12px;
    }
    
    /* CBè³‡è¨Šå¡ç‰‡ - åŸå§‹é¢¨æ ¼ */
    .cb-info-card {
        background: white;
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .cb-header {
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .cb-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .cb-name-info {
        flex: 1;
    }
    
    .cb-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .cb-code {
        font-size: 24px;
        font-weight: 700;
        color: #1a73e8;
    }
    
    .cb-price-info {
        text-align: right;
    }
    
    .cb-price {
        font-size: 32px;
        font-weight: 700;
        color: #ea4335;
    }
    
    .cb-change {
        font-size: 14px;
        color: #666;
        margin-top: 4px;
    }
    
    /* è³‡è¨Šåˆ—è¡¨ */
    .info-list {
        padding: 0;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #f5f5f5;
        transition: background 0.2s;
    }
    
    .info-item:active {
        background: #f8f9fa;
    }
    
    .info-label {
        color: #666;
        font-size: 15px;
    }
    
    .info-value {
        color: #333;
        font-weight: 600;
        font-size: 15px;
    }
    
    .info-value.red { color: #ea4335; }
    .info-value.green { color: #34a853; }
    
    /* åº•éƒ¨æŒ‰éˆ•çµ„ */
    .bottom-actions {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: #f8f9fa;
    }
    
    .action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        display: block;
    }
    
    .action-btn.primary, label.action-btn.primary {
        background: #1a73e8;
        color: white;
    }
    
    .action-btn.secondary {
        background: white;
        color: #666;
        border: 1px solid #e0e0e0;
    }
    
    /* åœ–è¡¨å€åŸŸ */
    .chart-section {
        background: white;
        margin: 20px;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .time-selector {
        display: flex;
        gap: 8px;
    }
    
    .time-btn {
        padding: 6px 12px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        font-size: 13px;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .time-btn.active {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    /* å¿«é€Ÿé€£çµ */
    .quick-links {
        padding: 20px;
    }
    
    .quick-links-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .links-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .link-card {
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .link-card:active {
        transform: scale(0.98);
    }
    
    .link-icon {
        font-size: 28px;
        margin-bottom: 8px;
    }
    
    .link-text {
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }
    
    /* åˆ—è¡¨æ¨£å¼ */
    .list-section {
        background: white;
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .list-header {
        padding: 16px 20px;
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .list-item {
        display: flex;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #f5f5f5;
        transition: background 0.2s;
        cursor: pointer;
    }
    
    .list-item:active {
        background: #f8f9fa;
    }
    
    .list-item-left {
        flex: 1;
    }
    
    .list-item-name {
        font-size: 15px;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
    }
    
    .list-item-code {
        font-size: 13px;
        color: #666;
    }
    
    .list-item-right {
        text-align: right;
    }
    
    .list-item-price {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .list-item-change {
        font-size: 13px;
    }
    
    .list-item-change.up { color: #ea4335; }
    .list-item-change.down { color: #34a853; }
    
    /* è¼‰å…¥ç•«é¢ */
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f0f0f0;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        color: #666;
        font-size: 15px;
    }
    
    /* æª”æ¡ˆä¸Šå‚³å€ */
    .file-upload {
        position: relative;
    }
    
    .file-input {
        display: none;
    }
    
    .file-status {
        font-size: 12px;
        margin-top: 8px;
    }
    
    .status-ok { color: #34a853; }
    .status-error { color: #ea4335; }
    .status-loading { color: #1a73e8; }
</style>
```

</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
    </div>

```
<!-- é ‚éƒ¨å°èˆª -->
<header class="header">
    <div class="header-left">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="header-title">Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</div>
    </div>
    <div class="header-badge" id="dataBadge">è³‡æ–™åº«å°±ç·’ (å…± 1969 æª”)</div>
</header>

<!-- å´é‚Šé¸å–® -->
<div id="sidebar" class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“ˆ</div>
        <div class="sidebar-title">Rexå¤§å”168</div>
        <div class="sidebar-subtitle">å°ˆæ³¨é¢¨éšªãƒ»æ•¸æ“šé©…å‹•ãƒ»æ™ºèƒ½åˆ†æ</div>
    </div>
    
    <div class="menu-group">
        <div class="menu-group-title">ä¸»è¦åŠŸèƒ½</div>
        <a class="menu-item active" onclick="showPage('home')">
            <span class="menu-icon">ğŸ </span>
            <span class="menu-text">CBæœå°‹é¦–é </span>
        </a>
        <a class="menu-item" onclick="showPage('ranking')">
            <span class="menu-icon">ğŸ“Š</span>
            <span class="menu-text">CBæ’è¡Œæ¦œ</span>
        </a>
        <a class="menu-item" onclick="showPage('cbas')">
            <span class="menu-icon">ğŸ’</span>
            <span class="menu-text">CBASæ¬Šåˆ©é‡‘</span>
        </a>
        <a class="menu-item" onclick="showPage('upload')">
            <span class="menu-icon">ğŸ“</span>
            <span class="menu-text">æª”æ¡ˆä¸Šå‚³</span>
        </a>
    </div>
</div>

<!-- é®ç½©å±¤ -->
<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<!-- ä¸»å…§å®¹å€ -->
<main class="main-content">
    <!-- æœå°‹å€ -->
    <div class="search-container">
        <div class="search-title">
            <span>ğŸ”</span>
            <span>æœå°‹é¢æ¿</span>
        </div>
        <div class="search-subtitle">è¼¸å…¥ä»£è™Ÿæˆ–åç¨±ï¼š</div>
        <input type="text" class="search-input" id="searchInput" 
               placeholder="è«‹è¼¸å…¥CBä»£è™Ÿæˆ–åç¨±" 
               value="23836"
               inputmode="numeric">
        <button class="search-btn" onclick="performSearch()">é–‹å§‹æŸ¥è©¢</button>
        <div class="search-hint">â€» è‹¥ç„¡æ³•è®€å–ï¼Œè«‹æ‰‹å‹•ä¸Šå‚³ï¼š</div>
    </div>
    
    <!-- CBè³‡è¨Šå¡ç‰‡ -->
    <div class="cb-info-card">
        <div class="cb-header">
            <div class="cb-title-row">
                <div class="cb-name-info">
                    <div class="cb-name" id="cbName">å°å…‰é›»å…­</div>
                    <div class="cb-code" id="cbCode">23836</div>
                </div>
                <div class="cb-price-info">
                    <div class="cb-price" id="cbPrice">203.77</div>
                    <div class="cb-change" id="cbChange">æº¢åƒ¹ç‡ --%</div>
                </div>
            </div>
        </div>
        
        <div class="info-list">
            <div class="info-item">
                <span class="info-label">æ”¶ç›¤åƒ¹</span>
                <span class="info-value" id="closePrice">203.77</span>
            </div>
            <div class="info-item">
                <span class="info-label">è½‰æ›åƒ¹</span>
                <span class="info-value" id="conversionPrice">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ¨™çš„è‚¡åƒ¹</span>
                <span class="info-value" id="stockPrice">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">è½‰æ›åƒ¹å€¼</span>
                <span class="info-value" id="conversionValue">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æº¢åƒ¹ç‡</span>
                <span class="info-value" id="premiumRate">-%</span>
            </div>
        </div>
        
        <div class="bottom-actions">
            <label for="fileInput" class="action-btn primary">é¸æ“‡æª”æ¡ˆ</label>
            <button class="action-btn secondary">æœªé¸å–æª”æ¡ˆ</button>
            <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls" multiple onchange="handleFiles(event)" style="display:none;">
        </div>
    </div>
    
    <!-- åœ–è¡¨å€åŸŸ -->
    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">
                <span>ğŸ“ˆ</span>
                <span>CBåƒ¹æ ¼èµ°å‹¢</span>
            </div>
            <div class="time-selector">
                <button class="time-btn active" onclick="changeTimeRange(1)">1M</button>
                <button class="time-btn" onclick="changeTimeRange(3)">3M</button>
                <button class="time-btn" onclick="changeTimeRange(6)">6M</button>
                <button class="time-btn" onclick="changeTimeRange(12)">1Y</button>
            </div>
        </div>
        <div class="chart-container" id="priceChart"></div>
    </div>
    
    <!-- CBæ’è¡Œæ¦œ -->
    <div class="list-section">
        <div class="list-header">CBåç¨±ã€€ã€€æ”¶ç›¤åƒ¹</div>
        <div id="cbListContent">
            <div class="list-item" onclick="selectCB('23836')">
                <div class="list-item-left">
                    <div class="list-item-name">å°å…‰é›»å…­</div>
                    <div class="list-item-code">23836</div>
                </div>
                <div class="list-item-right">
                    <div class="list-item-price">208.5</div>
                    <div class="list-item-change down">-1.2%</div>
                </div>
            </div>
            <div class="list-item" onclick="selectCB('23837')">
                <div class="list-item-left">
                    <div class="list-item-name">å°å…‰é›»ä¸ƒ</div>
                    <div class="list-item-code">23837</div>
                </div>
                <div class="list-item-right">
                    <div class="list-item-price">197.3</div>
                    <div class="list-item-change up">+0.8%</div>
                </div>
            </div>
        </div>
    </div>
</main>
```

<script>
// å…¨åŸŸè®Šæ•¸
let cbDatabase = {};        // CBåŸºæœ¬è³‡æ–™
let cbasData = {};         // CBASè³‡æ–™
let priceData = {};        // åƒ¹æ ¼è³‡æ–™
let currentCB = '23836';
let priceChart = null;
let filesLoaded = {
    cb: false,
    cbas: false,
    price: false
};

// å´é‚Šé¸å–®æ§åˆ¶
function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}

// é é¢åˆ‡æ›
function showPage(pageName) {
    closeMenu();
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    console.log('åˆ‡æ›åˆ°é é¢:', pageName);
}

// è™•ç†æª”æ¡ˆä¸Šå‚³
function handleFiles(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    document.getElementById('fileStatus').innerHTML = '<span class="status-loading">è®€å–æª”æ¡ˆä¸­...</span>';
    
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // æ ¹æ“šæª”æ¡ˆåç¨±åˆ¤æ–·é¡å‹
                const fileName = file.name.toLowerCase();
                if (fileName.includes('cbä»£è™Ÿ') || fileName.includes('00_cb')) {
                    processCBFile(workbook);
                    filesLoaded.cb = true;
                } else if (fileName.includes('cbas') || fileName.includes('æ‹†è§£')) {
                    processCBASFile(workbook);
                    filesLoaded.cbas = true;
                } else if (fileName.includes('æˆäº¤åƒ¹') || fileName.includes('04_cb')) {
                    processPriceFile(workbook);
                    filesLoaded.price = true;
                }
                
                checkFilesStatus();
                
            } catch (error) {
                console.error('æª”æ¡ˆè™•ç†éŒ¯èª¤:', error);
                document.getElementById('fileStatus').innerHTML = 
                    '<span class="status-error">æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message + '</span>';
            }
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// è™•ç†CBåŸºæœ¬è³‡æ–™æª”æ¡ˆ
function processCBFile(workbook) {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    cbDatabase = {};
    jsonData.forEach(row => {
        if (row['ä»£è™Ÿ']) {
            const cbCode = String(row['ä»£è™Ÿ']).padStart(5, '0');
            cbDatabase[cbCode] = {
                cb_code: cbCode,
                stock_code: String(row['è‚¡ç¥¨ä»£è™Ÿ'] || ''),
                name: row['åç¨±'] || '',
                conversion_price: parseFloat(row['è½‰æ›åƒ¹æ ¼']) || 0
            };
        }
    });
    
    console.log(`è¼‰å…¥CBè³‡æ–™: ${Object.keys(cbDatabase).length}ç­†`);
}

// è™•ç†CBASæª”æ¡ˆ
function processCBASFile(workbook) {
    cbasData = {};
    
    // è·³éç¬¬ä¸€å€‹ç¸½è¡¨
    for (let i = 1; i < workbook.SheetNames.length && i < 20; i++) {
        const sheetName = workbook.SheetNames[i];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 3 });
        
        const monthData = {};
        jsonData.forEach(row => {
            if (row[0] && !isNaN(row[0])) {
                const cbCode = String(row[0]).padStart(5, '0');
                monthData[cbCode] = {
                    premium_avg: parseFloat(row[6]) || 0
                };
            }
        });
        
        cbasData[sheetName] = monthData;
    }
    
    console.log(`è¼‰å…¥CBASè³‡æ–™: ${Object.keys(cbasData).length}å€‹æœˆ`);
}

// è™•ç†åƒ¹æ ¼æª”æ¡ˆ
function processPriceFile(workbook) {
    priceData = {};
    
    // è·³éç¬¬ä¸€å€‹ç¸½è¡¨
    for (let i = 1; i < workbook.SheetNames.length && i < 20; i++) {
        const sheetName = workbook.SheetNames[i];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        const monthData = {};
        jsonData.forEach(row => {
            if (row['ä»£è™Ÿ']) {
                const cbCode = String(row['ä»£è™Ÿ']).padStart(5, '0');
                monthData[cbCode] = {
                    avg_price: parseFloat(row['å¹³å‡']) || 0,
                    volume: parseInt(row['æˆäº¤é‡']) || 0
                };
            }
        });
        
        priceData[sheetName] = monthData;
    }
    
    console.log(`è¼‰å…¥åƒ¹æ ¼è³‡æ–™: ${Object.keys(priceData).length}å€‹æœˆ`);
}

// æª¢æŸ¥æª”æ¡ˆè¼‰å…¥ç‹€æ…‹
function checkFilesStatus() {
    const loaded = Object.values(filesLoaded).filter(v => v).length;
    
    if (loaded === 3) {
        document.getElementById('fileStatus').innerHTML = 
            '<span class="status-ok">âœ… æ‰€æœ‰æª”æ¡ˆè¼‰å…¥æˆåŠŸ</span>';
        document.getElementById('dataBadge').textContent = 
            `è³‡æ–™åº«å°±ç·’ (å…± ${Object.keys(cbDatabase).length} æª”)`;
        updateCBList();
        loadCBData(currentCB);
    } else {
        document.getElementById('fileStatus').innerHTML = 
            `<span class="status-loading">å·²è¼‰å…¥ ${loaded}/3 å€‹æª”æ¡ˆ</span>`;
    }
}

// æ›´æ–°CBåˆ—è¡¨
function updateCBList() {
    const listContent = document.getElementById('cbListContent');
    let html = '';
    let count = 0;
    
    for (let code in cbDatabase) {
        if (count >= 20) break;
        
        const cb = cbDatabase[code];
        const latestMonth = Object.keys(priceData).pop();
        const priceInfo = priceData[latestMonth]?.[code];
        const price = priceInfo ? priceInfo.avg_price.toFixed(2) : '--';
        
        html += `
            <div class="list-item" onclick="selectCB('${code}')">
                <div class="list-item-left">
                    <div class="list-item-name">${cb.name}</div>
                    <div class="list-item-code">${code}</div>
                </div>
                <div class="list-item-right">
                    <div class="list-item-price">${price}</div>
                    <div class="list-item-change ${Math.random() > 0.5 ? 'up' : 'down'}">
                        ${Math.random() > 0.5 ? '+' : '-'}${(Math.random() * 3).toFixed(2)}%
                    </div>
                </div>
            </div>
        `;
        count++;
    }
    
    listContent.innerHTML = html;
}

// æœå°‹åŠŸèƒ½
function performSearch() {
    const input = document.getElementById('searchInput').value.trim();
    if (!input) {
        alert('è«‹è¼¸å…¥CBä»£è™Ÿæˆ–åç¨±');
        return;
    }
    
    // å¦‚æœæ²’æœ‰è¼‰å…¥è³‡æ–™ï¼Œä½¿ç”¨æ¸¬è©¦è³‡æ–™
    if (Object.keys(cbDatabase).length === 0) {
        loadChart();
        return;
    }
    
    // æœå°‹CB
    const paddedInput = input.padStart(5, '0');
    if (cbDatabase[paddedInput]) {
        selectCB(paddedInput);
    } else {
        // æœå°‹åç¨±
        for (let code in cbDatabase) {
            if (cbDatabase[code].name.includes(input)) {
                selectCB(code);
                return;
            }
        }
        alert('æŸ¥ç„¡è³‡æ–™');
    }
}

// é¸æ“‡CB
function selectCB(cbCode) {
    currentCB = cbCode;
    document.getElementById('searchInput').value = cbCode;
    loadCBData(cbCode);
}

// è¼‰å…¥CBè³‡æ–™
function loadCBData(cbCode) {
    const cb = cbDatabase[cbCode];
    if (!cb) {
        // ä½¿ç”¨æ¸¬è©¦è³‡æ–™
        document.getElementById('cbName').textContent = 'å°å…‰é›»å…­';
        document.getElementById('cbCode').textContent = '23836';
        document.getElementById('cbPrice').textContent = '203.77';
        document.getElementById('closePrice').textContent = '203.77';
        loadChart();
        return;
    }
    
    // æ›´æ–°åŸºæœ¬è³‡è¨Š
    document.getElementById('cbName').textContent = cb.name;
    document.getElementById('cbCode').textContent = cbCode;
    
    // å–å¾—æœ€æ–°åƒ¹æ ¼
    const latestMonth = Object.keys(priceData).pop();
    const priceInfo = priceData[latestMonth]?.[cbCode];
    const price = priceInfo ? priceInfo.avg_price.toFixed(2) : '--';
    
    document.getElementById('cbPrice').textContent = price;
    document.getElementById('closePrice').textContent = price;
    
    // æ›´æ–°å…¶ä»–è³‡è¨Š
    document.getElementById('conversionPrice').textContent = 
        cb.conversion_price ? cb.conversion_price.toFixed(2) : '-';
    
    loadChart();
}

// è¼‰å…¥åœ–è¡¨
function loadChart() {
    if (!priceChart) {
        priceChart = echarts.init(document.getElementById('priceChart'));
    }
    
    // æ”¶é›†åƒ¹æ ¼è³‡æ–™
    const chartData = [];
    const months = Object.keys(priceData).slice(-12); // æœ€è¿‘12å€‹æœˆ
    
    months.forEach(month => {
        const monthData = priceData[month]?.[currentCB];
        if (monthData && monthData.avg_price > 0) {
            chartData.push({
                date: formatMonth(month),
                price: monthData.avg_price
            });
        }
    });
    
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨æ¸¬è©¦è³‡æ–™
    if (chartData.length === 0) {
        for (let i = 11; i >= 0; i--) {
            const date = new Date();
            date.setMonth(date.getMonth() - i);
            chartData.push({
                date: (date.getMonth() + 1) + 'æœˆ',
                price: 200 + Math.random() * 10
            });
        }
    }
    
    const option = {
        grid: {
            left: 50,
            right: 20,
            top: 20,
            bottom: 40
        },
        xAxis: {
            type: 'category',
            data: chartData.map(d => d.date),
            axisLabel: {
                fontSize: 10
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                fontSize: 10
            }
        },
        series: [{
            data: chartData.map(d => d.price.toFixed(2)),
            type: 'line',
            smooth: true,
            lineStyle: {
                width: 2,
                color: '#ea4335'
            },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(234,67,53,0.2)' },
                    { offset: 1, color: 'rgba(234,67,53,0)' }
                ])
            },
            symbol: 'none'
        }]
    };
    
    priceChart.setOption(option);
}

// æ ¼å¼åŒ–æœˆä»½
function formatMonth(monthStr) {
    if (monthStr.length >= 4) {
        return monthStr.substring(2, 4) + 'æœˆ';
    }
    return monthStr;
}

// æ”¹è®Šæ™‚é–“ç¯„åœ
function changeTimeRange(months) {
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    // é‡æ–°è¼‰å…¥åœ–è¡¨ï¼ˆé€™è£¡å¯ä»¥æ ¹æ“šmonthsåƒæ•¸èª¿æ•´é¡¯ç¤ºç¯„åœï¼‰
    loadChart();
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
    // éš±è—è¼‰å…¥ç•«é¢
    setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
    }, 500);
    
    // è¼‰å…¥æ¸¬è©¦åœ–è¡¨
    setTimeout(() => {
        loadChart();
    }, 600);
});

// è™•ç†è¦–çª—èª¿æ•´
window.addEventListener('resize', () => {
    if (priceChart) {
        priceChart.resize();
    }
});

// Enteréµæœå°‹
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});
</script>

</body>
</html>