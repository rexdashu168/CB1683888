<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æˆ°æƒ…å®¤ (v14.0 çµ•å°æ•‘æ´ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e3c72; --secondary: #2a5298; --accent: #00b4d8; --bg: #f1f5f9; --text: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-top: 60px; }

        /* é ‚éƒ¨å°èˆª */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { font-size: 18px; margin: 0; font-weight: 700; }
        
        /* ç³»çµ±ç‹€æ…‹èˆ‡é™¤éŒ¯è¦–çª— */
        #console-box {
            position: fixed; bottom: 0; right: 0; width: 100%; max-width: 400px; height: 150px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: auto; z-index: 9999; border-top-left-radius: 10px;
            display: none; /* é è¨­éš±è—ï¼Œæœ‰è¼‰å…¥å‹•ä½œæ™‚é¡¯ç¤º */
        }

        /* æœå°‹å€ */
        .search-area { padding: 20px; background: white; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .input-group { display: flex; gap: 10px; max-width: 600px; margin: 0 auto; }
        .search-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        .search-btn { padding: 0 25px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* è¼‰å…¥æŒ‰éˆ•å€ (æ•‘æ´æ¨¡å¼) */
        .upload-zone { 
            text-align: center; padding: 40px 20px; background: white; margin: 20px; 
            border-radius: 16px; border: 2px dashed #cbd5e1; 
        }
        .big-btn { 
            background: var(--primary); color: white; padding: 15px 30px; 
            border-radius: 50px; font-size: 18px; cursor: pointer; border: none; 
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3); transition: 0.2s;
            display: inline-flex; align-items: center; gap: 10px;
        }
        .big-btn:active { transform: scale(0.95); }

        /* å¡ç‰‡åˆ—è¡¨ */
        .container { padding: 0 15px 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid transparent; }
        .card:hover { border-left-color: var(--accent); transform: translateX(5px); transition: 0.2s; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .cb-title { font-size: 18px; font-weight: 800; color: var(--primary); }
        .cb-code { font-size: 14px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
        
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .label { color: #94a3b8; }
        .val { font-weight: 600; color: var(--text); }
        .red { color: #ef4444; } .blue { color: #3b82f6; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; justify-content: center; align-items: flex-start; }
        .modal-content { background: white; width: 100%; max-width: 800px; border-radius: 16px; padding: 25px; position: relative; margin-top: 20px; margin-bottom: 50px; }
        .close-btn { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #999; }

        /* åœ–è¡¨ */
        .chart-box { height: 300px; width: 100%; border: 1px solid #e2e8f0; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Rexå¤§å” æˆ°æƒ…å®¤ v14.0</h1>
        <div id="status" style="font-size:12px; color:#fff;">ç­‰å¾…è¼‰å…¥...</div>
    </div>

    <div id="uploadArea" class="upload-zone">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“‚</div>
        <h3 style="margin-bottom: 5px; color: var(--primary);">è«‹è¼‰å…¥è³‡æ–™åº«</h3>
        <p style="color: #64748b; margin-bottom: 20px;">è«‹ä¸€æ¬¡é¸å– 00, 01, 02, 04 å››å€‹ Excel æª”æ¡ˆ</p>
        
        <label class="big-btn">
            <span>é»æ­¤é¸æ“‡æª”æ¡ˆ</span>
            <input type="file" id="fileInput" multiple accept=".xlsx" style="display:none" onchange="handleFiles(event)">
        </label>
    </div>

    <div id="searchArea" class="search-area" style="display:none;">
        <div class="input-group">
            <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚: 68732)ã€åç¨± (å¦‚: äºåŠ›)..." onkeyup="if(event.key==='Enter') doSearch()">
            <button class="search-btn" onclick="doSearch()">æŸ¥è©¢</button>
        </div>
    </div>

    <div id="resultList" class="container"></div>

    <div id="console-box"></div>

    <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">Ã—</span>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// å…¨åŸŸè³‡æ–™åº«
const DB = {
    basic: {},    // 00_CB (åŸºæœ¬)
    highlow: {},  // 00_CB (é«˜ä½)
    auction: {},  // 00_CB (ç«¶æ‹)
    cbas: {},     // 02_CBAS (æœ€æ–°)
    prices: {},   // 04_Price (æ­·å²)
    reports: {},  // 01_Report
    industry: {}  // 00_CB (ç”¢æ¥­)
};

// è¨˜éŒ„ Log
function log(msg) {
    const box = document.getElementById('console-box');
    box.style.display = 'block';
    const time = new Date().toLocaleTimeString();
    box.innerHTML += `[${time}] ${msg}<br>`;
    box.scrollTop = box.scrollHeight;
    console.log(msg);
}

// è™•ç†æª”æ¡ˆä¸Šå‚³
function handleFiles(event) {
    const files = event.target.files;
    if (files.length === 0) return;

    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('searchArea').style.display = 'block';
    log(`æ”¶åˆ° ${files.length} å€‹æª”æ¡ˆï¼Œé–‹å§‹è§£æ...`);

    let processed = 0;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                parseWorkbook(file.name, workbook);
                processed++;
                if (processed === files.length) {
                    log("âœ… æ‰€æœ‰æª”æ¡ˆè§£æå®Œæˆï¼è«‹é–‹å§‹æœå°‹ã€‚");
                    document.getElementById('status').innerText = "è³‡æ–™åº«å°±ç·’";
                    // é è¨­é¡¯ç¤ºä¸€äº›è³‡æ–™ç¢ºèª
                    doSearch(' '); 
                }
            } catch (err) {
                log(`âŒ è§£æå¤±æ•— ${file.name}: ${err.message}`);
            }
        };
        reader.readAsArrayBuffer(file);
    });
}

// æ™ºæ…§è§£æ (æ ¸å¿ƒä¿®æ­£ï¼šè‡ªå‹•æ‰¾æ¨™é¡Œåˆ—)
function parseWorkbook(filename, wb) {
    const lowerName = filename.toLowerCase();
    log(`æ­£åœ¨è™•ç†: ${filename}`);

    // 1. åˆ¤æ–·æª”æ¡ˆé¡å‹
    let type = 'unknown';
    if (lowerName.includes('00') || lowerName.includes('åŸºæœ¬') || lowerName.includes('cbä»£è™Ÿ')) type = 'basic';
    else if (lowerName.includes('01') || lowerName.includes('report') || lowerName.includes('å ±å‘Š')) type = 'report';
    else if (lowerName.includes('02') || lowerName.includes('cbas') || lowerName.includes('æ‹†è§£')) type = 'cbas';
    else if (lowerName.includes('04') || lowerName.includes('price') || lowerName.includes('æˆäº¤')) type = 'price';

    wb.SheetNames.forEach(sheetName => {
        const sheet = wb.Sheets[sheetName];
        // ä½¿ç”¨ header:1 è®€å–åŸå§‹é™£åˆ—ï¼Œè§£æ±ºæ¨™é¡Œä¸åœ¨ç¬¬ä¸€è¡Œçš„å•é¡Œ
        const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        if (!rawData || rawData.length === 0) return;

        // å°‹æ‰¾æ¨™é¡Œåˆ— (æƒæå‰ 10 è¡Œ)
        let headerRowIndex = -1;
        let headers = [];
        for (let i = 0; i < Math.min(10, rawData.length); i++) {
            const row = rawData[i];
            // åˆ¤æ–·é—œéµå­—ä¾†èªå®šé€™æ˜¯ä¸æ˜¯æ¨™é¡Œåˆ—
            if (row.some(cell => cell && (String(cell).includes('ä»£è™Ÿ') || String(cell).includes('åç¨±') || String(cell).includes('æ—¥æœŸ')))) {
                headerRowIndex = i;
                headers = row;
                break;
            }
        }

        if (headerRowIndex === -1) return; // æ²’æ‰¾åˆ°æ¨™é¡Œï¼Œè·³éæ­¤å·¥ä½œè¡¨

        // è½‰æ›ç‚ºç‰©ä»¶é™£åˆ—
        const jsonData = [];
        for (let i = headerRowIndex + 1; i < rawData.length; i++) {
            const row = rawData[i];
            let obj = {};
            headers.forEach((h, index) => {
                if (h) obj[String(h).trim()] = row[index];
            });
            jsonData.push(obj);
        }

        // åˆ†æµå„²å­˜è³‡æ–™
        if (type === 'basic') {
            if (sheetName.includes('åŸºæœ¬') || sheetName.includes('01')) {
                jsonData.forEach(row => mapData(DB.basic, row));
            } else if (sheetName.includes('æ›ç‰Œ') || sheetName.includes('00')) {
                jsonData.forEach(row => mapData(DB.highlow, row));
            } else if (sheetName.includes('ç«¶æ‹') || sheetName.includes('04')) {
                jsonData.forEach(row => mapData(DB.auction, row));
            } else if (sheetName.includes('ç”¢æ¥­')) {
                jsonData.forEach(row => {
                    const stock = getVal(row, ['è‚¡ç¥¨ä»£è™Ÿ','ä»£è™Ÿ']);
                    if(stock) DB.industry[stock] = row;
                });
            }
        } 
        else if (type === 'cbas') {
            // è™•ç† CBAS æ­·å²
            const dateMatch = sheetName.match(/\d+/);
            if (dateMatch) { // æ˜¯æœˆä»½å·¥ä½œè¡¨
                const dateStr = dateMatch[0]; // 11201
                jsonData.forEach(row => {
                    const code = getVal(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
                    if (code) {
                        const price = getVal(row, ['æœ€ä½æ¬Šåˆ©é‡‘(å…ƒ)','æ¬Šåˆ©é‡‘']);
                        const principal = getVal(row, ['åç›®æœ¬é‡‘']);
                        const vol = principal ? Math.round(principal/100000) : 0;
                        
                        // å­˜å…¥æ­·å²
                        if (!DB.cbas[code]) DB.cbas[code] = { history: [], latest: {} };
                        DB.cbas[code].history.push({ date: dateStr, price, vol });
                        
                        // æ›´æ–°æœ€æ–°
                        if (!DB.cbas[code].latest.date || dateStr > DB.cbas[code].latest.date) {
                            DB.cbas[code].latest = { date: dateStr, price, vol };
                        }
                    }
                });
            }
        }
        else if (type === 'price') {
            // è™•ç†æ­·å²è‚¡åƒ¹
            const dateMatch = sheetName.match(/\d+/);
            if (dateMatch) {
                const dateStr = dateMatch[0];
                jsonData.forEach(row => {
                    const code = getVal(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
                    if (code) {
                        if (!DB.prices[code]) DB.prices[code] = [];
                        DB.prices[code].push({
                            date: dateStr,
                            price: getVal(row, ['å¹³å‡','å¹³å‡åƒ¹']),
                            high: getVal(row, ['æœ€é«˜','æœ€é«˜åƒ¹'])
                        });
                    }
                });
            }
        }
        else if (type === 'report') {
            jsonData.forEach(row => {
                const stock = getVal(row, ['è‚¡è™Ÿ','è‚¡ç¥¨ä»£è™Ÿ']);
                if (stock) {
                    if (!DB.reports[stock]) DB.reports[stock] = [];
                    DB.reports[stock].push(row);
                }
            });
        }
    });
}

// è¼”åŠ©ï¼šå°‡è³‡æ–™å­˜å…¥ DB
function mapData(target, row) {
    const code = getVal(row, ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'å‚µåˆ¸ä»£ç¢¼']);
    if (code) target[code] = row;
}

// è¼”åŠ©ï¼šæ¨¡ç³Šå–å€¼
function getVal(row,
