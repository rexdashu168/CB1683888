<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤ (v11.0 ç©©å®šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e3c72; --secondary: #2a5298; --accent: #0ea5e9; --bg: #f8fafc; --text: #1e293b; --sidebar-w: 280px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-top: 60px; overflow-x: hidden; }
        
        /* è¼‰å…¥ç•«é¢èˆ‡éŒ¯èª¤è™•ç† */
        .loader-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        .log-text { font-family: monospace; color: #64748b; font-size: 12px; margin-top: 10px; height: 20px; }
        
        /* éŒ¯èª¤æ•‘æ´å€å¡Š */
        .rescue-box { display: none; background: #fff1f2; border: 1px solid #fecdd3; padding: 25px; border-radius: 12px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.3s; }
        .rescue-btn { background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; border: none; font-size: 15px; cursor: pointer; margin-top: 15px; width: 100%; font-weight: 600; }
        .rescue-btn:hover { background: var(--secondary); }

        /* Header & Sidebar */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .sidebar { position: fixed; left: calc(var(--sidebar-w) * -1); top: 0; width: var(--sidebar-w); height: 100vh; background: white; transition: left 0.3s ease; z-index: 2000; overflow-y: auto; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar.active { left: 0; }
        .sidebar-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 30px 20px; color: white; }
        .menu-group { padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .menu-item { display: flex; align-items: center; padding: 14px 20px; cursor: pointer; color: #333; gap: 12px; text-decoration: none; font-weight: 500; transition: 0.2s; }
        .menu-item:hover { background: #f8f9fa; color: var(--accent); }
        .menu-item.active { background: #e0f2fe; color: var(--primary); border-left: 4px solid var(--primary); }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .overlay.active { display: block; }

        /* Pages */
        .page-content { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page-content.active { display: block; }
        
        /* Search & Cards */
        .search-container { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .input-group { display: flex; gap: 10px; margin-top: 15px; }
        .search-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; outline: none; }
        .search-btn { padding: 0 24px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .card:hover { transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }
        .data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .data-item { background: #f8fafc; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .data-label { font-size: 12px; color: #64748b; }
        .data-value { font-size: 16px; font-weight: 600; color: var(--text); }
        .red { color: #ef4444; } .green { color: #10b981; } .blue { color: #3b82f6; }

        /* Modal & Chart */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; overflow-y: auto; padding: 20px 0; backdrop-filter: blur(2px); }
        .modal.active { display: flex; justify-content: center; align-items: flex-start; }
        .modal-content { background: white; width: 95%; max-width: 900px; border-radius: 16px; padding: 25px; position: relative; margin-bottom: 50px; animation: slideUp 0.3s; }
        .chart-box { height: 320px; width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-top: 15px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader" class="loader-screen">
        <div class="spinner" id="spinner"></div>
        <h3 style="color: var(--primary);">Rexå¤§å”æˆ°æƒ…å®¤</h3>
        <div id="logText" class="log-text">ç³»çµ±å•Ÿå‹•ä¸­...</div>
        
        <div id="rescueBox" class="rescue-box">
            <h3 style="color:#ef4444; margin:0 0 10px 0;">âš ï¸ ç„¡æ³•è‡ªå‹•é€£ç·š</h3>
            <p style="font-size:14px; color:#64748b; line-height:1.5;">
                ç€è¦½å™¨å®‰å…¨æ€§é˜»æ­¢äº†è‡ªå‹•è®€å–ï¼Œ<br>æˆ–è€… GitHub æª”åä¸ä¸€è‡´ã€‚<br>
                <b>è«‹ç›´æ¥é¸å–é‚£ 4 å€‹ Excel æª”å³å¯å•Ÿå‹•ï¼š</b>
            </p>
            <label class="rescue-btn">
                ğŸ“‚ é»æ­¤æ‰‹å‹•è¼‰å…¥æª”æ¡ˆ
                <input type="file" id="fileInput" multiple accept=".xlsx" style="display:none" onchange="handleManualUpload(event)">
            </label>
            <div style="font-size:12px; color:#94a3b8; margin-top:10px;">
                (00_CBä»£è™Ÿåç¨±, 01_cb168report, 02_CBAS..., 04_CB...)
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-left"><button class="menu-btn" onclick="toggleMenu()">â˜°</button><span class="header-title">Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</span></div>
        <div id="dbBadge" style="font-size:12px; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:15px;">è³‡æ–™åº«: 0 æª”</div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header"><div style="font-size:20px; font-weight:800;">Rexå¤§å”168</div><div>Flagship v11.0</div></div>
        <div class="menu-group">
            <a class="menu-item active" onclick="showPage('home')">ğŸ  æˆ°æƒ…å®¤é¦–é </a>
            <a class="menu-item" onclick="showPage('basic')">ğŸ“‹ CB åŸºæœ¬è³‡æ–™</a>
            <a class="menu-item" onclick="showPage('highlow')">ğŸ“Š æ›ç‰Œé«˜ä½</a>
            <a class="menu-item" onclick="showPage('auction')">ğŸ”¨ ç«¶æ‹æ•¸æ“š</a>
        </div>
        <div class="menu-group">
            <a class="menu-item" onclick="showPage('cbas')">ğŸ“ˆ CBAS æ‹†è§£</a>
            <a class="menu-item" onclick="showPage('report')">ğŸ“‘ ç ”ç©¶å ±å‘Š</a>
            <a class="menu-item" onclick="showPage('industry')">ğŸ­ ç”¢æ¥­æ¦‚å¿µ</a>
        </div>
    </div>
    <div id="overlay" class="overlay" onclick="closeMenu()"></div>

    <div id="page-home" class="page-content active">
        <div class="search-container">
            <h3>ğŸ” æ™ºèƒ½æœå°‹</h3>
            <div class="input-group">
                <input type="text" class="search-input" id="mainSearch" placeholder="è¼¸å…¥ä»£è™Ÿ (68732)ã€åç¨±æˆ–æ¦‚å¿µè‚¡..." onkeyup="if(event.key==='Enter') doSearch()">
                <button class="search-btn" onclick="doSearch()">æŸ¥è©¢</button>
            </div>
        </div>
        <div id="homeResults"><div style="text-align:center; padding:60px; color:#cbd5e1;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹åˆ†æ</div></div>
    </div>
    <div id="page-basic" class="page-content"><h2>ğŸ“‹ CB åŸºæœ¬è³‡æ–™</h2><div id="basicList"></div></div>
    <div id="page-highlow" class="page-content"><h2>ğŸ“Š æ›ç‰Œé«˜ä½</h2><div id="highlowList"></div></div>
    <div id="page-auction" class="page-content"><h2>ğŸ”¨ ç«¶æ‹æ•¸æ“š</h2><div id="auctionList"></div></div>
    <div id="page-cbas" class="page-content"><h2>ğŸ“ˆ CBAS æ‹†è§£</h2><div id="cbasList"></div></div>
    <div id="page-report" class="page-content"><h2>ğŸ“‘ ç ”ç©¶å ±å‘Š</h2><div id="reportList"></div></div>
    <div id="page-industry" class="page-content"><h2>ğŸ­ ç”¢æ¥­æ¦‚å¿µ</h2><div id="industryList"></div></div>

    <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div style="position:absolute; right:20px; top:20px; font-size:24px; cursor:pointer;" onclick="closeModal()">Ã—</div>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// 1. è³‡æ–™åº«çµæ§‹
const DB = { basic:{}, highlow:{}, auction:{}, industry:{}, concepts:{}, reports:{}, news:[], cbas_latest:{}, cbas_history:{}, prices:{} };

// *** çµ•å°è·¯å¾‘èˆ‡æª”åè¨­å®š ***
const FILES = [
    { id: '00', name: '00_CBä»£è™Ÿåç¨±.xlsx' },
    { id: '01', name: '01_cb168report.xlsx' },
    { id: '02', name: '02_CBASæœˆæ‹†è§£è¡¨.xlsx' },
    { id: '04', name: '04_CBæœˆæˆäº¤åƒ¹è¡¨.xlsx' }
];

// 2. ç³»çµ±å•Ÿå‹•
window.onload = function() {
    // è¨­å®š 2.5 ç§’é€¾æ™‚ï¼Œå¦‚æœæ²’è¼‰å…¥æˆåŠŸå°±é¡¯ç¤ºæ‰‹å‹•æ•‘æ´
    setTimeout(() => {
        if (Object.keys(DB.basic).length === 0) {
            showRescueMode("é€£ç·šé€¾æ™‚ï¼Œè«‹æ‰‹å‹•è¼‰å…¥");
        }
    }, 2500);
    
    attemptAutoLoad();
};

async function attemptAutoLoad() {
    const log = document.getElementById('logText');
    let successCount = 0;

    for (let file of FILES) {
        try {
            log.innerText = `æ­£åœ¨é€£çµ: ${file.name}...`;
            const res = await fetch(file.name);
            if (!res.ok) throw new Error('404 Not Found');
            const ab = await res.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            parseWorkbook(file.id, wb);
            successCount++;
        } catch (err) {
            console.warn(`è‡ªå‹•è¼‰å…¥å¤±æ•—: ${file.name}`);
        }
    }
    
    if (successCount > 0) {
        initUI();
    } else {
        showRescueMode("æ‰¾ä¸åˆ°æª”æ¡ˆæˆ–ç€è¦½å™¨å®‰å…¨é™åˆ¶");
    }
}

function showRescueMode(msg) {
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('logText').style.display = 'none';
    document.getElementById('rescueBox').style.display = 'block';
}

function handleManualUpload(event) {
    const files = event.target.files;
    if (!files.length) return;
    
    document.getElementById('rescueBox').style.display = 'none';
    document.getElementById('spinner').style.display = 'block';
    document.getElementById('logText').style.display = 'block';
    document.getElementById('logText').innerText = "æ­£åœ¨è§£æé¸å–çš„æª”æ¡ˆ...";

    let processed = 0;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type: 'array'});
            // æ¨¡ç³Šæ¯”å°æª”å
            let typeId = '00';
            if (file.name.includes('01') || file.name.includes('report')) typeId = '01';
            else if (file.name.includes('02') || file.name.includes('CBAS')) typeId = '02';
            else if (file.name.includes('04') || file.name.includes('æˆäº¤')) typeId = '04';
            
            parseWorkbook(typeId, wb);
            processed++;
            if (processed === files.length) initUI();
        };
        reader.readAsArrayBuffer(file);
    });
}

function initUI() {
    document.getElementById('loader').style.display = 'none';
    updateDbStatus();
    renderList('highlow'); 
}

// 3. è§£æé‚è¼¯
function parseWorkbook(id, wb) {
    const sheetNames = wb.SheetNames;

    if (id === '00') {
        processSheet(wb, ['åŸºæœ¬è³‡æ–™'], row => {
            const code = getField(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
            if(code) DB.basic[code] = row;
        });
        processSheet(wb, ['æ›ç‰Œé«˜ä½'], row => {
            const code = getField(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
            if(code) DB.highlow[code] = row;
        });
        processSheet(wb, ['ç«¶æ‹'], row => {
            const code = getField(row, ['CBä»£è™Ÿ']);
            if(code) DB.auction[code] = row;
        });
        processSheet(wb, ['ç”¢æ¥­åˆ†é¡'], row => {
            const stock = getField(row, ['è‚¡ç¥¨ä»£è™Ÿ','ä»£è™Ÿ']);
            if(stock) DB.industry[stock] = row;
        });
    }
    else if (id === '01') {
        processSheet(wb, ['æ¦‚å¿µè‚¡'], row => {
            const stock = getField(row, ['è‚¡ç¥¨ä»£è™Ÿ']);
            if(stock) { if(!DB.concepts[stock]) DB.concepts[stock]=[]; DB.concepts[stock].push(row); }
        });
        processSheet(wb, ['è©³ç´°å…§å®¹'], row => {
            const stock = getField(row, ['è‚¡è™Ÿ']);
            if(stock) { if(!DB.reports[stock]) DB.reports[stock]=[]; DB.reports[stock].push(row); }
        });
        processSheet(wb, ['å¤–é›»'], row => { if(row['å…¬å¸']) DB.news.push(row); });
    }
    else if (id === '02') {
        sheetNames.forEach(name => {
            if(name.match(/^\d+/)) {
                const data = XLSX.utils.sheet_to_json(wb.Sheets[name]);
                const dateStr = parseTwDate(name);
                data.forEach(row => {
                    const code = getField(row, ['CBä»£è™Ÿ']);
                    if(code) {
                        if(!DB.cbas_history[code]) DB.cbas_history[code] = [];
                        const principal = parseFloat(getField(row,['åç›®æœ¬é‡‘']))||0;
                        const vol = Math.round(principal/100000);
                        const minP = parseFloat(getField(row,['æœ€ä½æ¬Šåˆ©é‡‘(å…ƒ)']))||0;
                        
                        DB.cbas_history[code].push({ date: dateStr, vol, minPrice: minP });
                        
                        const curr = DB.cbas_latest[code];
                        if(!curr || dateStr > curr.date) DB.cbas_latest[code] = { ...row, date: dateStr, vol, minPrice: minP };
                    }
                });
            }
        });
        for(let c in DB.cbas_history) DB.cbas_history[c].sort((a,b)=>a.date.localeCompare(b.date));
    }
    else if (id === '04') {
        sheetNames.forEach(name => {
            if(name.match(/^\d+/)) {
                const data = XLSX.utils.sheet_to_json(wb.Sheets[name]);
                const dateStr = parseTwDate(name);
                data.forEach(row => {
                    const code = getField(row, ['ä»£è™Ÿ']);
                    if(code) {
                        if(!DB.prices[code]) DB.prices[code] = [];
                        DB.prices[code].push({
                            date: dateStr,
                            price: parseFloat(getField(row, ['å¹³å‡']))||0,
                            high: parseFloat(getField(row, ['æœ€é«˜']))||0,
                            low: parseFloat(getField(row, ['æœ€ä½']))||0
                        });
                    }
                });
            }
        });
        for(let c in DB.prices) DB.prices[c].sort((a,b)=>a.date.localeCompare(b.date));
    }
}

function parseTwDate(name) {
    const year = parseInt(name.slice(0, -2)) + 1911;
    const month = name.slice(-2);
    return `${year}-${month}`;
}
function processSheet(wb, keys, cb) {
    const name = wb.SheetNames.find(n => keys.some(k => n.includes(k)));
    if(name) XLSX.utils.sheet_to_json(wb.Sheets[name]).forEach(cb);
}
function getField(row, keys) {
    for(let k of keys) if(row[k]!==undefined) return String(row[k]).trim();
    return null;
}
function updateDbStatus() {
    document.getElementById('dbBadge').innerText = `DB: ${Object.keys(DB.basic).length} æª”`;
}

// UI Functions
function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
function closeMenu() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
function showPage(id) {
    closeMenu();
    document.querySelectorAll('.page-content').forEach(e => e.classList.remove('active'));
    document.getElementById(`page-${id}`).classList.add('active');
    if(id !== 'home') renderList(id);
}

function doSearch() {
    const val = document.getElementById('mainSearch').value.trim().toUpperCase();
    if(!val) return;
    const resDiv = document.getElementById('homeResults');
    resDiv.innerHTML = '';
    
    const results = new Set();
    for (let code in DB.basic) {
        const b = DB.basic[code];
        if (code.includes(val) || b['åç¨±'].includes(val) || b['è‚¡ç¥¨ä»£è™Ÿ'].includes(val)) results.add(code);
    }
    for(let stock in DB.concepts) {
        if(DB.concepts[stock].some(c => c['æ¦‚å¿µåˆ†é¡']?.includes(val) || c['é¡Œæèªªæ˜']?.includes(val))) {
            for(let c in DB.basic) if(DB.basic[c]['è‚¡ç¥¨ä»£è™Ÿ']==stock) results.add(c);
        }
    }

    if(results.size===0) { resDiv.innerHTML='<div style="text-align:center;padding:30px;color:#999">æŸ¥ç„¡è³‡æ–™</div>'; return; }
    
    results.forEach(code => {
        const b = DB.basic[code];
        const cbas = DB.cbas_latest[code] || {};
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => showDetail(code);
        div.innerHTML = `
            <div class="card-header">
                <div><span class="cb-name">${b['åç¨±']||code}</span> <span class="cb-code">${code}</span></div>
                <div class="data-value blue">${cbas.minPrice||'--'}</div>
            </div>
            <div class="data-grid">
                <div class="data-item"><div class="data-label">ç™¼è¡Œè¦æ¨¡</div><div>${b['ç™¼è¡Œè¦æ¨¡']||'--'}å„„</div></div>
                <div class="data-item"><div class="data-label">è½‰æ›åƒ¹æ ¼</div><div>${b['è½‰æ›åƒ¹æ ¼']||'--'}</div></div>
            </div>
        `;
        resDiv.appendChild(div);
    });
}

function renderList(id) {
    const div = document.getElementById(id+'List');
    div.innerHTML = '';
    let src = DB.basic;
    if(id==='auction') src=DB.auction;
    if(id==='cbas') src=DB.cbas_latest;
    
    let count=0;
    for(let c in src) {
        if(count++ > 50) break;
        const code = getField(src[c],['CBä»£è™Ÿ','ä»£è™Ÿ']) || c;
        const realCode = DB.basic[code] ? code : Object.keys(DB.basic).find(k=>k.includes(code));
        if(realCode && DB.basic[realCode]) {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => showDetail(realCode);
            el.innerHTML = `<div class="card-header"><b>${DB.basic[realCode]['åç¨±']}</b> <span style="color:#999;font-size:12px">${realCode}</span></div>`;
            div.appendChild(el);
        }
    }
}

function showDetail(code) {
    const b = DB.basic[code]||{};
    const hl = DB.highlow[code]||{};
    const a = DB.auction[code]||{};
    const cbas = DB.cbas_latest[code]||{};
    const pHist = DB.prices[code]||[];
    const cHist = DB.cbas_history[code]||[];
    const stock = getField(b,['è‚¡ç¥¨ä»£è™Ÿ']);
    const ind = DB.industry[stock]||{};
    const conc = DB.concepts[stock]||[];
    const reps = DB.reports[stock]||[];

    const modalBody = document.getElementById('modalBody');
    const tags = conc.map(c=>`<span class="tag tag-green" style="background:#dcfce7;padding:2px 6px;border-radius:4px;font-size:12px;margin-right:5px;">${c['æ¦‚å¿µåˆ†é¡']}</span>`).join('');

    modalBody.innerHTML = `
        <h2 style="margin-bottom:5px">${b['åç¨±']} <span style="color:#666;font-size:16px">${code}</span></h2>
        <div style="margin-bottom:15px">${tags} <span class="tag tag-blue" style="background:#e0f2fe;padding:2px 6px;border-radius:4px;font-size:12px;">${ind['ç´°åˆ†ç”¢æ¥­']||''}</span></div>
        
        <div class="data-grid" style="margin-bottom:20px">
            <div class="data-item"><div class="data-label">æ¬Šåˆ©é‡‘</div><div class="data-value red">${cbas.minPrice||'--'}</div></div>
            <div class="data-item"><div class="data-label">æ‹†è§£å¼µæ•¸</div><div class="data-value blue">${cbas.volume||'--'}</div></div>
            <div class="data-item"><div class="data-label">æ›ç‰Œæœ€é«˜</div><div class="red">${hl['æ›ç‰Œæœ€é«˜']||'--'}</div></div>
            <div class="data-item"><div class="data-label">å¹³å‡å¾—æ¨™</div><div>${getField(a,['å¹³å‡å¾—æ¨™'])||'--'}</div></div>
        </div>

        <div class="chart-box" id="chart"></div>

        <h3 style="font-size:16px; margin:20px 0 10px; border-left:4px solid var(--accent); padding-left:8px;">æ³•äººè§€é»</h3>
        <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; max-height:200px; overflow-y:auto;">
            ${reps.length ? reps.map(r=>`<div style="border-bottom:1px dashed #eee; padding:5px 0; font-size:13px;"><b>${r['åˆ¸å•†']}</b>: ${r['ç²¾ç°¡é‡é»æ‘˜è¦']||''}</div>`).join('') : '<div style="text-align:center;color:#999">ç„¡å ±å‘Š</div>'}
        </div>
    `;
    
    document.getElementById('detailModal').classList.add('active');
    
    setTimeout(() => {
        if(pHist.length > 0 || cHist.length > 0) {
            const chart = echarts.init(document.getElementById('chart'));
            const dates = Array.from(new Set([...pHist.map(x=>x.date), ...cHist.map(x=>x.date)])).sort();
            const pData = dates.map(d => (pHist.find(x=>x.date===d) || {}).price);
            const cData = dates.map(d => (cHist.find(x=>x.date===d) || {}).minPrice);

            chart.setOption({
                tooltip: { trigger: 'axis' },
                legend: { data:['è‚¡åƒ¹','æ¬Šåˆ©é‡‘'], bottom:0 },
                grid: { left:'10%', right:'10%', top:'10%', bottom:'15%' },
                xAxis: { type: 'category', data: dates },
                yAxis: [
                    { type: 'value', name: 'è‚¡åƒ¹', position: 'left' },
                    { type: 'value', name: 'æ¬Šåˆ©é‡‘', position: 'right', splitLine:{show:false} }
                ],
                series: [
                    { name:'è‚¡åƒ¹', type:'line', data:pData, itemStyle:{color:'#1e3c72'}, smooth:true },
                    { name:'æ¬Šåˆ©é‡‘', type:'line', yAxisIndex:1, data:cData, itemStyle:{color:'#ef4444'}, smooth:true }
                ]
            });
            window.onresize = () => chart.resize();
        } else {
            document.getElementById('chart').innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#999">ç„¡æ­·å²æ•¸æ“š</div>';
        }
    }, 200);
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }
</script>
</body>
</html>
