<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤ (Auto v15.0)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ====== 1. è¦–è¦ºç³»çµ± ====== */
        :root { --primary: #0f172a; --secondary: #334155; --accent: #0ea5e9; --bg: #f8fafc; --text: #1e293b; --sidebar-w: 280px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-top: 60px; overflow-x: hidden; }
        
        /* ====== 2. è¼‰å…¥ç•«é¢ (è‡ªå‹•åŒ–æ ¸å¿ƒ) ====== */
        .loader-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        .status-text { font-size: 14px; color: #64748b; font-weight: 500; margin-top: 10px; height: 20px; }
        .progress-container { width: 240px; height: 4px; background: #f1f5f9; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        
        /* åªæœ‰åœ¨çœŸçš„å¤±æ•—æ™‚æ‰é¡¯ç¤ºçš„æ‰‹å‹•æ•‘æ´æŒ‰éˆ• (é è¨­éš±è—) */
        .fallback-btn { display: none; margin-top: 20px; padding: 10px 20px; background: #ef4444; color: white; border-radius: 8px; cursor: pointer; font-size: 14px; border: none; }

        /* ====== 3. ä»‹é¢å¸ƒå±€ ====== */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .header-title { font-size: 18px; font-weight: 700; margin-left: 10px; }
        .db-badge { font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 15px; }

        .sidebar { position: fixed; left: calc(var(--sidebar-w) * -1); top: 0; width: var(--sidebar-w); height: 100vh; background: white; transition: left 0.3s ease; z-index: 2000; box-shadow: 4px 0 15px rgba(0,0,0,0.1); overflow-y: auto; }
        .sidebar.active { left: 0; }
        .sidebar-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 30px 20px; color: white; }
        .menu-group { padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .menu-item { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; color: #333; text-decoration: none; font-weight: 500; transition: 0.2s; }
        .menu-item:hover { background: #f0f9ff; color: var(--accent); }
        .menu-item.active { background: #e0f2fe; color: var(--primary); border-left: 4px solid var(--primary); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .overlay.active { display: block; }

        /* ====== 4. å…§å®¹å€ ====== */
        .page-content { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page-content.active { display: block; }
        
        .search-container { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; text-align: center; }
        .input-group { display: flex; gap: 10px; margin-top: 15px; }
        .search-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; outline: none; }
        .search-btn { padding: 0 24px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #f1f5f9; transition: 0.2s; }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        .cb-name { font-size: 18px; font-weight: 800; color: var(--primary); }
        .data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .data-item { background: #f8fafc; padding: 8px; border-radius: 6px; text-align: center; }
        .data-label { font-size: 11px; color: #64748b; }
        .data-value { font-size: 15px; font-weight: 700; color: var(--text); }
        .red { color: #ef4444; } .green { color: #10b981; } .blue { color: #3b82f6; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 3000; overflow-y: auto; padding: 20px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; justify-content: center; align-items: flex-start; }
        .modal-content { background: white; width: 100%; max-width: 900px; border-radius: 16px; padding: 25px; position: relative; margin-bottom: 50px; animation: slideUp 0.3s; }
        .chart-box { height: 320px; width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-top: 15px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader" class="loader-screen">
        <div class="spinner"></div>
        <h3 style="color:var(--primary)">Rexå¤§å” æˆ°æƒ…å®¤ v15.0</h3>
        <div id="loadText" class="status-text">ç³»çµ±è‡ªå‹•é€£ç·šä¸­...</div>
        <div class="progress-container"><div id="progressFill" class="progress-bar"></div></div>
        
        <label class="fallback-btn" id="fallbackBtn">
            âš ï¸ è‡ªå‹•é€£ç·šå¤±æ•—ï¼Œè«‹é»æ­¤æ‰‹å‹•é¸å– 4 å€‹ Excel æª”
            <input type="file" multiple accept=".xlsx" style="display:none" onchange="handleManualUpload(event)">
        </label>
    </div>

    <header class="header">
        <div class="header-left"><button class="menu-btn" onclick="toggleMenu()">â˜°</button><span class="header-title">Rexå¤§å” æ™ºèƒ½CBæˆ°æƒ…å®¤</span></div>
        <div class="db-badge" id="dbBadge">DB: åŒæ­¥ä¸­</div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header"><div style="font-size:20px; font-weight:800;">Rexå¤§å”168</div><div>Auto-Sync System</div></div>
        <div class="menu-group">
            <a class="menu-item active" onclick="showPage('home')">ğŸ  æˆ°æƒ…å®¤é¦–é </a>
            <a class="menu-item" onclick="showPage('basic')">ğŸ“‹ CB åŸºæœ¬è³‡æ–™</a>
            <a class="menu-item" onclick="showPage('highlow')">ğŸ“Š æ›ç‰Œé«˜ä½</a>
            <a class="menu-item" onclick="showPage('auction')">ğŸ”¨ ç«¶æ‹æ•¸æ“š</a>
        </div>
        <div class="menu-group">
            <a class="menu-item" onclick="showPage('cbas')">ğŸ“ˆ CBAS æ‹†è§£</a>
            <a class="menu-item" onclick="showPage('report')">ğŸ“‘ ç ”ç©¶å ±å‘Š</a>
            <a class="menu-item" onclick="showPage('industry')">ğŸ­ ç”¢æ¥­æ¦‚å¿µ</a>
        </div>
    </div>
    <div id="overlay" class="overlay" onclick="closeMenu()"></div>

    <div id="page-home" class="page-content active">
        <div class="search-container">
            <h3>ğŸ” æ™ºèƒ½æœå°‹</h3>
            <div class="input-group">
                <input type="text" class="search-input" id="mainSearch" placeholder="è¼¸å…¥ä»£è™Ÿã€åç¨±æˆ–æ¦‚å¿µ..." onkeyup="if(event.key==='Enter') doSearch()">
                <button class="search-btn" onclick="doSearch()">æŸ¥è©¢</button>
            </div>
        </div>
        <div id="homeResults"><div style="text-align:center; padding:60px; color:#cbd5e1;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹åˆ†æ</div></div>
    </div>

    <div id="page-basic" class="page-content"><h2>ğŸ“‹ CB åŸºæœ¬è³‡æ–™</h2><div id="basicList"></div></div>
    <div id="page-highlow" class="page-content"><h2>ğŸ“Š æ›ç‰Œé«˜ä½</h2><div id="highlowList"></div></div>
    <div id="page-auction" class="page-content"><h2>ğŸ”¨ ç«¶æ‹æ•¸æ“š</h2><div id="auctionList"></div></div>
    <div id="page-cbas" class="page-content"><h2>ğŸ“ˆ CBAS æ‹†è§£</h2><div id="cbasList"></div></div>
    <div id="page-report" class="page-content"><h2>ğŸ“‘ ç ”ç©¶å ±å‘Š</h2><div id="reportList"></div></div>
    <div id="page-industry" class="page-content"><h2>ğŸ­ ç”¢æ¥­æ¦‚å¿µ</h2><div id="industryList"></div></div>

    <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div style="position:absolute; right:20px; top:20px; font-size:24px; cursor:pointer;" onclick="closeModal()">Ã—</div>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// 1. è³‡æ–™åº«çµæ§‹
const DB = { basic:{}, highlow:{}, auction:{}, industry:{}, concepts:{}, reports:{}, news:[], cbas_latest:{}, cbas_history:{}, prices:{} };

// *** æ™ºæ…§æª”åè¨­å®š (æœƒä¾åºå˜—è©¦) ***
const FILES_CONFIG = [
    { id: '00', names: ['00_CBä»£è™Ÿåç¨±.xlsx', '00_CB.xlsx', '00_CBä»£è™Ÿåç¨±(1).xlsx'], desc: 'åŸºæœ¬è³‡æ–™' },
    { id: '01', names: ['01_cb168report.xlsx', '01_Report.xlsx'], desc: 'ç ”ç©¶å ±å‘Š' },
    { id: '02', names: ['02_CBASæœˆæ‹†è§£è¡¨.xlsx', '02_CBAS.xlsx', '02_CBASæœˆæ‹†è§£è¡¨(2).xlsx'], desc: 'CBASæ•¸æ“š' },
    { id: '04', names: ['04_CBæœˆæˆäº¤åƒ¹è¡¨.xlsx', '04_Price.xlsx', '04_CBæœˆæˆäº¤åƒ¹è¡¨(2).xlsx'], desc: 'æ­·å²è‚¡åƒ¹' }
];

// 2. è‡ªå‹•å•Ÿå‹•
window.onload = function() {
    autoLoadFiles();
};

// è‡ªå‹•è¼‰å…¥é‚è¼¯ (å˜—è©¦å¤šç¨®æª”å)
async function autoLoadFiles() {
    const statusEl = document.getElementById('loadText');
    const fillEl = document.getElementById('progressFill');
    let loadedCount = 0;
    let hasError = false;

    for (let config of FILES_CONFIG) {
        let fileLoaded = false;
        
        // å˜—è©¦è©² ID çš„æ‰€æœ‰å¯èƒ½æª”å
        for (let name of config.names) {
            try {
                statusEl.innerText = `æ­£åœ¨ä¸‹è¼‰: ${name}...`;
                const res = await fetch(name);
                if (res.ok) {
                    const ab = await res.arrayBuffer();
                    const wb = XLSX.read(ab, { type: 'array' });
                    statusEl.innerText = `è§£æè³‡æ–™: ${config.desc}...`;
                    parseWorkbook(config.id, wb); // è§£ææˆåŠŸ
                    fileLoaded = true;
                    break; // æˆåŠŸå°±è·³å‡ºè¿´åœˆï¼Œæ›ä¸‹ä¸€å€‹ ID
                }
            } catch (e) {
                // ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹æª”å
            }
        }

        if (fileLoaded) {
            loadedCount++;
            fillEl.style.width = `${(loadedCount / FILES_CONFIG.length) * 100}%`;
        } else {
            console.warn(`ç„¡æ³•è¼‰å…¥é¡åˆ¥: ${config.desc} (æ‰€æœ‰æª”åå˜—è©¦å¤±æ•—)`);
            hasError = true;
        }
    }

    if (loadedCount > 0) {
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            updateDbStatus();
            renderList('highlow'); // é è¨­é¡¯ç¤º
        }, 500);
    } else {
        // å…¨è»è¦†æ²’ï¼Œé¡¯ç¤ºæ‰‹å‹•æŒ‰éˆ•
        statusEl.innerText = "è‡ªå‹•é€£ç·šå¤±æ•— (è«‹æ‰‹å‹•è¼‰å…¥)";
        statusEl.style.color = "red";
        document.getElementById('fallbackBtn').style.display = 'inline-block';
    }
}

// æ‰‹å‹•ä¸Šå‚³è™•ç† (æœ€å¾Œé˜²ç·š)
function handleManualUpload(event) {
    const files = event.target.files;
    if (!files.length) return;
    
    document.getElementById('fallbackBtn').style.display = 'none';
    document.getElementById('loadText').innerText = "æ­£åœ¨è§£ææœ¬æ©Ÿæª”æ¡ˆ...";
    document.getElementById('loadText').style.color = "#64748b";
    
    let processed = 0;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type: 'array'});
            
            // æ¨¡ç³Šè­˜åˆ¥æª”æ¡ˆé¡å‹
            let typeId = '00';
            if (file.name.includes('01') || file.name.includes('report')) typeId = '01';
            else if (file.name.includes('02') || file.name.includes('CBAS')) typeId = '02';
            else if (file.name.includes('04') || file.name.includes('æˆäº¤')) typeId = '04';
            
            parseWorkbook(typeId, wb);
            processed++;
            if(processed === files.length) {
                document.getElementById('loader').style.display = 'none';
                updateDbStatus();
                renderList('highlow');
            }
        };
        reader.readAsArrayBuffer(file);
    });
}

// 3. è§£ææ ¸å¿ƒ (ä½¿ç”¨æ™ºæ…§æ¨™é¡Œæœå°‹)
function parseWorkbook(id, wb) {
    wb.SheetNames.forEach(sheetName => {
        const sheet = wb.Sheets[sheetName];
        const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // è®€å–åŸå§‹é™£åˆ—
        if (!rawData || rawData.length === 0) return;

        // å°‹æ‰¾æ¨™é¡Œåˆ— (æƒæå‰10è¡Œ)
        let headerRowIndex = -1;
        let headers = [];
        for (let i = 0; i < Math.min(10, rawData.length); i++) {
            const row = rawData[i];
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ¨™é¡Œåˆ— (åŒ…å«é—œéµå­—)
            if (row.some(cell => cell && (String(cell).includes('ä»£è™Ÿ') || String(cell).includes('åç¨±') || String(cell).includes('æ¬Šåˆ©é‡‘') || String(cell).includes('åƒ¹æ ¼')))) {
                headerRowIndex = i;
                headers = row;
                break;
            }
        }
        if (headerRowIndex === -1) return; // æ²’æ¨™é¡Œå°±è·³é

        // è½‰ç‚ºç‰©ä»¶
        const data = [];
        for (let i = headerRowIndex + 1; i < rawData.length; i++) {
            const row = rawData[i];
            let obj = {};
            headers.forEach((h, idx) => { if(h) obj[String(h).trim()] = row[idx]; });
            data.push(obj);
        }

        // åˆ†æµè™•ç†
        if (id === '00') {
            if (sheetName.includes('åŸºæœ¬') || sheetName.includes('01')) data.forEach(row => { const c=getVal(row,['CBä»£è™Ÿ','ä»£è™Ÿ']); if(c) DB.basic[c]=row; });
            if (sheetName.includes('æ›ç‰Œ') || sheetName.includes('00')) data.forEach(row => { const c=getVal(row,['CBä»£è™Ÿ','ä»£è™Ÿ']); if(c) DB.highlow[c]=row; });
            if (sheetName.includes('ç«¶æ‹') || sheetName.includes('04')) data.forEach(row => { const c=getVal(row,['CBä»£è™Ÿ']); if(c) DB.auction[c]=row; });
            if (sheetName.includes('ç”¢æ¥­') || sheetName.includes('16')) data.forEach(row => { const s=getVal(row,['è‚¡ç¥¨ä»£è™Ÿ','ä»£è™Ÿ']); if(s) DB.industry[s]=row; });
        }
        else if (id === '01') {
            if (sheetName.includes('æ¦‚å¿µ')) data.forEach(row => { const s=getVal(row,['è‚¡ç¥¨ä»£è™Ÿ']); if(s) { if(!DB.concepts[s]) DB.concepts[s]=[]; DB.concepts[s].push(row); } });
            if (sheetName.includes('è©³ç´°') || sheetName.includes('å€‹è‚¡')) data.forEach(row => { const s=getVal(row,['è‚¡è™Ÿ','è‚¡ç¥¨ä»£è™Ÿ']); if(s) { if(!DB.reports[s]) DB.reports[s]=[]; DB.reports[s].push(row); } });
            if (sheetName.includes('å¤–é›»')) data.forEach(row => { if(row['å…¬å¸']) DB.news.push(row); });
        }
        else if (id === '02') {
            // CBAS æ­·å²
            const dateMatch = sheetName.match(/\d+/);
            if (dateMatch) {
                const dateStr = parseTwDate(dateMatch[0]);
                data.forEach(row => {
                    const code = getVal(row, ['CBä»£è™Ÿ','å¯è½‰å‚µä»£è™Ÿ']);
                    if(code) {
                        if(!DB.cbas_history[code]) DB.cbas_history[code] = [];
                        const prin = parseFloat(getVal(row,['åç›®æœ¬é‡‘']))||0;
                        const vol = Math.round(prin/100000);
                        const price = parseFloat(getVal(row,['æœ€ä½æ¬Šåˆ©é‡‘(å…ƒ)','æ¬Šåˆ©é‡‘']))||0;
                        DB.cbas_history[code].push({ date:dateStr, vol, minPrice:price });
                        
                        const curr = DB.cbas_latest[code];
                        if(!curr || dateStr > curr.date) DB.cbas_latest[code] = { ...row, date:dateStr, volume:vol, minPrice:price };
                    }
                });
            }
        }
        else if (id === '04') {
            // æ­·å²è‚¡åƒ¹
            const dateMatch = sheetName.match(/\d+/);
            if (dateMatch) {
                const dateStr = parseTwDate(dateMatch[0]);
                data.forEach(row => {
                    const code = getVal(row, ['CBä»£è™Ÿ','ä»£è™Ÿ']);
                    if(code) {
                        if(!DB.prices[code]) DB.prices[code] = [];
                        DB.prices[code].push({
                            date: dateStr,
                            price: parseFloat(getVal(row,['å¹³å‡','å¹³å‡åƒ¹']))||0,
                            high: parseFloat(getVal(row,['æœ€é«˜','æœ€é«˜åƒ¹']))||0
                        });
                    }
                });
            }
        }
    });
}

// å·¥å…·
function parseTwDate(str) {
    if(str.length > 5) str = str.substring(0,5); // å–å‰5ç¢¼é¿å…æª”åå¾Œç¶´å¹²æ“¾
    const y = parseInt(str.slice(0, -2)) + 1911;
    const m = str.slice(-2);
    return `${y}-${m}`;
}
function getVal(row, keys) {
    for(let k of keys) if(row[k]!==undefined) return String(row[k]).trim();
    return null;
}
function updateDbStatus() {
    const count = Object.keys(DB.basic).length;
    document.getElementById('dbBadge').innerText = `DB: ${count} æª”`;
}

// UI
function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
function closeMenu() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
function showPage(id) {
    closeMenu();
    document.querySelectorAll('.page-content').forEach(e => e.classList.remove('active'));
    document.getElementById(`page-${id}`).classList.add('active');
    document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');
    if(id !== 'home') renderList(id);
}

function doSearch() {
    const val = document.getElementById('mainSearch').value.trim().toUpperCase();
    if(!val) return;
    const resDiv = document.getElementById('homeResults');
    resDiv.innerHTML = '';
    const results = new Set();

    for(let c in DB.basic) {
        const b = DB.basic[c];
        if(c.includes(val) || b['åç¨±'].includes(val) || b['è‚¡ç¥¨ä»£è™Ÿ'].includes(val)) results.add(c);
    }
    for(let s in DB.concepts) {
        if(DB.concepts[s].some(x => x['æ¦‚å¿µåˆ†é¡']?.includes(val) || x['é¡Œæèªªæ˜']?.includes(val))) {
            for(let c in DB.basic) if(DB.basic[c]['è‚¡ç¥¨ä»£è™Ÿ']==s) results.add(c);
        }
    }

    if(results.size===0) { resDiv.innerHTML='<div style="text-align:center;padding:30px;color:#999">æŸ¥ç„¡è³‡æ–™</div>'; return; }
    
    results.forEach(code => {
        const b = DB.basic[code];
        const cbas = DB.cbas_latest[code] || {};
        const hl = DB.highlow[code] || {};
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => showDetail(code);
        div.innerHTML = `
            <div class="card-header">
                <div><span class="cb-name">${b['åç¨±']}</span> <span style="font-size:14px;color:#666">${code}</span></div>
                <div class="data-value blue">${cbas.minPrice||'--'}</div>
            </div>
            <div class="data-grid">
                <div class="data-item"><div class="data-label">ç™¼è¡Œè¦æ¨¡</div><div>${b['ç™¼è¡Œè¦æ¨¡']||'--'}å„„</div></div>
                <div class="data-item"><div class="data-label">è½‰æ›åƒ¹æ ¼</div><div>${b['è½‰æ›åƒ¹æ ¼']||'--'}</div></div>
                <div class="data-item"><div class="data-label">æ›ç‰Œæœ€é«˜</div><div class="red">${hl['æ›ç‰Œæœ€é«˜']||'--'}</div></div>
                <div class="data-item"><div class="data-label">æ‹†è§£å¼µæ•¸</div><div>${cbas.volume||'--'}</div></div>
            </div>
        `;
        resDiv.appendChild(div);
    });
}

function renderList(id) {
    const div = document.getElementById(id+'List');
    div.innerHTML = '';
    let src = DB.basic;
    if(id==='auction') src=DB.auction;
    if(id==='cbas') src=DB.cbas_latest;
    
    let count=0;
    for(let c in src) {
        if(count++ > 50) break;
        const code = getVal(src[c],['CBä»£è™Ÿ','ä»£è™Ÿ']) || c;
        const realCode = DB.basic[code] ? code : Object.keys(DB.basic).find(k=>k.includes(code));
        if(realCode) {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => showDetail(realCode);
            el.innerHTML = `<div class="card-header"><b>${DB.basic[realCode]['åç¨±']}</b> (${realCode})</div>`;
            div.appendChild(el);
        }
    }
}

function showDetail(code) {
    const b = DB.basic[code]||{};
    const hl = DB.highlow[code]||{};
    const a = DB.auction[code]||{};
    const cbas = DB.cbas_latest[code]||{};
    const pHist = DB.prices[code]||[];
    const cHist = DB.cbas_history[code]||[];
    const stock = getVal(b,['è‚¡ç¥¨ä»£è™Ÿ','è‚¡è™Ÿ']);
    const ind = DB.industry[stock]||{};
    const conc = DB.concepts[stock]||[];
    const reps = DB.reports[stock]||[];

    const modalBody = document.getElementById('modalBody');
    const tags = conc.map(c=>`<span class="tag" style="background:#dcfce7;color:#166534">${c['æ¦‚å¿µåˆ†é¡']}</span>`).join('');

    modalBody.innerHTML = `
        <h2 style="margin-bottom:5px">${b['åç¨±']} <span style="font-size:16px;color:#666">${code}</span></h2>
        <div style="margin-bottom:15px; font-size:13px; color:#64748b;">
            ${ind['ç”¢æ¥­åˆ†é¡']||''} > ${ind['ç´°åˆ†ç”¢æ¥­']||''} ${tags}
        </div>

        <div class="data-grid" style="margin-bottom:20px">
            <div class="data-item"><div class="data-label">æœ€ä½æ¬Šåˆ©é‡‘</div><div class="data-value red">${cbas.minPrice||'--'}</div></div>
            <div class="data-item"><div class="data-label">æ‹†è§£å¼µæ•¸</div><div class="data-value blue">${cbas.volume||'--'}</div></div>
            <div class="data-item"><div class="data-label">ç«¶æ‹å‡åƒ¹</div><div>${getVal(a,['å¹³å‡å¾—æ¨™'])||'--'}</div></div>
            <div class="data-item"><div class="data-label">æ›ç‰Œæœ€é«˜</div><div>${hl['æ›ç‰Œæœ€é«˜']||'--'}</div></div>
        </div>

        <div class="chart-box" id="chart"></div>

        <h3 style="font-size:16px; margin:20px 0 10px; border-left:4px solid var(--accent); padding-left:10px;">æ³•äººå ±å‘Š</h3>
        <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; max-height:250px; overflow-y:auto;">
            ${reps.length ? reps.map(r=>`<div style="border-bottom:1px dashed #eee; padding:8px 0; font-size:13px;">
                <div style="display:flex; justify-content:space-between;"><b>${r['åˆ¸å•†']}</b> <span>${r['æŠ•è³‡è©•ç­‰']||''}</span></div>
                <div style="color:#666; margin-top:4px;">${r['ç²¾ç°¡é‡é»æ‘˜è¦']||''}</div>
            </div>`).join('') : '<div style="text-align:center;color:#999">æš«ç„¡å ±å‘Š</div>'}
        </div>
    `;
    
    document.getElementById('detailModal').classList.add('active');
    
    setTimeout(() => {
        if(pHist.length > 0 || cHist.length > 0) {
            const chart = echarts.init(document.getElementById('chart'));
            const dates = Array.from(new Set([...pHist.map(x=>x.date), ...cHist.map(x=>x.date)])).sort();
            
            const pData = dates.map(d => (pHist.find(x=>x.date===d) || {}).price);
            const cData = dates.map(d => (cHist.find(x=>x.date===d) || {}).minPrice);

            chart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                legend: { data: ['è‚¡åƒ¹', 'æ¬Šåˆ©é‡‘'], bottom: 0 },
                grid: { left: '10%', right: '10%', top: '10%', bottom: '15%' },
                xAxis: { type: 'category', data: dates },
                yAxis: [
                    { type: 'value', name: 'è‚¡åƒ¹', position: 'left' },
                    { type: 'value', name: 'æ¬Šåˆ©é‡‘', position: 'right', splitLine: { show: false } }
                ],
                series: [
                    { name: 'è‚¡åƒ¹', type: 'line', data: pData, itemStyle: { color: '#1e3c72' }, smooth: true },
                    { name: 'æ¬Šåˆ©é‡‘', type: 'line', yAxisIndex: 1, data: cData, itemStyle: { color: '#ef4444' }, smooth: true }
                ]
            });
            window.onresize = () => chart.resize();
        } else {
            document.getElementById('chart').innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#999">ç„¡æ­·å²æ•¸æ“š</div>';
        }
    }, 200);
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }
</script>
</body>
</html>
